<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repr Timeline</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --surface: #ffffff;
      --surface-hover: #f7f9f9;
      --surface-card: #f7f9f9;
      --border: #eff3f4;
      --text-primary: #0f1419;
      --text-secondary: #536471;
      --text-muted: #8b98a5;
      --accent: #1d9bf0;
      --green: #00ba7c;
      --red: #f4212e;
      --font-mono: 'JetBrains Mono', 'Monaco', monospace;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.4;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      min-height: 100vh;
      background: #fff;
    }

    /* Profile Header */
    .profile-header {
      padding: 24px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      z-index: 10;
      position: sticky;
      top: 0;
      display: flex;
      gap: 16px;
    }

    .profile-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--green);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 24px;
      color: white;
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .profile-info h1 {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin-bottom: 2px;
    }

    .profile-handle {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 0;
    }

    .profile-bio {
      font-size: 15px;
      color: var(--text-primary);
      margin-top: 8px;
    }

    .profile-status {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface-card);
      width: fit-content;
      padding: 4px 12px;
      border-radius: 20px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      background: var(--green);
      border-radius: 50%;
    }

    /* Tabs Bar Wrapper */
    .tabs-bar {
      display: flex;
      align-items: center;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 105px;
      z-index: 5;
      padding-right: 16px;
      /* Space for search */
    }

    /* Repo Tabs */
    .repo-tabs {
      display: flex;
      gap: 0;
      overflow-x: auto;
      flex: 1;
      /* Remove sticky from here as parent handles it */
    }

    .repo-tab {
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .repo-tab:hover {
      background: var(--surface-hover);
      color: var(--text-primary);
    }

    .repo-tab.active {
      color: var(--text-primary);
      border-bottom-color: var(--accent);
    }

    /* Feed & Post */
    .feed {
      display: flex;
      flex-direction: column;
    }

    .post {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .post:hover {
      background: var(--surface-hover);
    }

    .post-content {
      flex: 1;
      min-width: 0;
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: white;
      flex-shrink: 0;
      position: relative;
      z-index: 1;
      border: 4px solid var(--bg);
      background: var(--text-primary);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .name {
      font-weight: 600;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .category {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .category.feature {
      background: #ddf4ff;
      color: #0969da;
    }

    .category.bugfix {
      background: #ffebe9;
      color: #cf222e;
    }

    .category.refactor {
      background: #fff8c5;
      color: #9a6700;
    }

    .category.docs {
      background: #dafbe1;
      color: #1a7f37;
    }

    .category.chore {
      background: #f6f8fa;
      color: #57606a;
    }

    .category.infra {
      background: #fbefff;
      color: #8250df;
    }

    .time {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .time::before {
      content: "·";
      margin: 0 4px;
    }

    .post-title {
      font-weight: 700;
      font-size: 18px;
      margin: 8px 0;
      line-height: 1.3;
      color: var(--text-primary);
    }

    .post-problem {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 6px;
      line-height: 1.5;
    }

    .post-approach {
      font-size: 15px;
      margin-bottom: 8px;
      color: var(--text-primary);
      line-height: 1.5;
    }

    /* Skills in Header */
    .skills-inline {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-left: auto;
    }

    .skill-tag {
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
      background: var(--surface-card);
      padding: 1px 6px;
      border-radius: 4px;
    }

    /* Code Blocks */
    .diagram-block {
      background: var(--surface-card);
      border-left: 2px solid var(--border);
      padding: 12px 16px;
      margin-top: 12px;
      border-radius: 0 6px 6px 0;
      overflow-x: auto;
    }

    .diagram-block pre {
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.4;
      color: var(--text-secondary);
      margin: 0;
      white-space: pre;
    }

    /* Metrics & Insights */
    .file-metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .file-metric-card {
      background: var(--surface-card);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .file-name {
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      word-break: break-all;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .metric-label {
      color: var(--text-muted);
    }

    .metric-val {
      font-family: var(--font-mono);
    }

    .insight-box {
      background: #ddf4ff;
      border-left: 4px solid #0969da;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 24px;
    }

    .insight-label {
      font-size: 12px;
      font-weight: 700;
      color: #0969da;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .insight-text {
      font-size: 15px;
      line-height: 1.5;
      color: #0c2d6b;
      font-weight: 500;
    }

    .snippet-block {
      background: #0d1117;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
      font-family: var(--font-mono);
    }

    .snippet-header {
      background: #161b22;
      padding: 8px 16px;
      font-size: 12px;
      color: #c9d1d9;
      border-bottom: 1px solid #30363d;
    }

    .snippet-code {
      padding: 16px;
      font-size: 12px;
      line-height: 1.5;
      color: #e6edf3;
      overflow-x: auto;
    }

    .section-subtitle {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      margin-top: 16px;
    }

    /* Search Input */
    .search-container {
      /* Remove margin-left: auto since flex parent handles it */
      display: flex;
      align-items: center;
      margin-left: auto;
    }

    .search-input {
      background: var(--surface-card);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-primary);
      width: 200px;
      outline: none;
      transition: all 0.2s;
    }

    .search-input:focus {
      border-color: var(--accent);
      width: 240px;
      background: #fff;
    }

    .highlight {
      background-color: rgba(255, 235, 59, 0.4);
      border-radius: 2px;
      padding: 0 1px;
    }

    /* File Tags */
    .files-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .file-tag {
      background: var(--surface-card);
      border: 1px solid var(--border);
      padding: 4px 10px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-secondary);
      display: inline-block;
    }
  </style>
</head>

<body>
  <div class="container" id="view-feed">
    <header class="profile-header">
      <div class="profile-avatar">M</div>
      <div class="profile-info">
        <h1>Mendrika</h1>
        <div class="profile-handle">@mendrika</div>
        <p class="profile-bio">Building the future of coding agents.</p>
        <div class="profile-status">
          <span class="status-dot"></span>
          <span id="status-text">Loading...</span>
        </div>
      </div>
    </header>

    <div class="tabs-bar">
      <nav class="repo-tabs" id="repo-tabs"></nav>
      <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search stories...">
      </div>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <div class="container" id="view-detail" style="display: none;">
    <header class="profile-header" style="border-bottom: 0; background: rgba(255,255,255,0.98);">
      <div style="display: flex; align-items: center; gap: 16px; width: 100%;">
        <div onclick="goBack()"
          style="cursor: pointer; padding: 8px; margin-left: -8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
          onmouseover="this.style.background='var(--surface-hover)'" onmouseout="this.style.background='transparent'">
          <span style="font-size: 20px; color: var(--text-primary); line-height: 1;">←</span>
        </div>
        <div>
          <h2
            style="font-size: 14px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">
            Story Details</h2>
        </div>
      </div>
    </header>

    <div id="detail-content" style="padding-bottom: 40px; padding: 0;"></div>
  </div>

  <script>
    let allStories = [];
    let currentRepo = 'all';
    let searchQuery = '';

    const MOCK_STORIES = [
      {
        id: "mock-1",
        repo_name: "cli",
        category: "feature",
        title: "Restore dashboard diff functionality and improve branch suggestions",
        problem: "The dashboard lacked diff visualization, and internal models required refactoring to support better branch suggestions.",
        approach: "Executed a refactor of core data models and synthesis logic to improve code representation, then restored the diff view in the dashboard.",
        created_at: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(),
        technologies: ["Python", "SQLite", "Jinja2"],
        lessons: ["Separating the 'Synthesis' logic from the 'Presentation' logic made the diff rendering 3x faster."],
        files: ["src/dashboard.py", "templates/index.html"],
        implementation_details: [
          "Refactored `DiffGenerator` class to handle binary files gracefully.",
          "Updated Jinja2 templates to loop through file deltas.",
          "Added caching layer for diffs larger than 1MB."
        ],
        key_snippets: [
          {
            file_path: "src/dashboard.py",
            line_count: 15,
            content: "def get_diff(self, file_path):\n    # Check cache first\n    if file_path in self.cache:\n        return self.cache[file_path]\n    \n    # Generate diff\n    diff = git.diff(file_path)\n    return diff"
          }
        ]
      },
      {
        id: "mock-2",
        repo_name: "repr",
        category: "chore",
        title: "docs: update CLI usage messages for clarity",
        problem: "The previous usage messages were too generic and lacked context for specific arguments.",
        approach: "Updated help strings in Typer/Click definitions to include examples.",
        created_at: new Date(Date.now() - 1000 * 60 * 60 * 5).toISOString(),
        technologies: ["Python", "Typer"],
        files: ["cli/main.py"]
      },
      {
        id: "mock-3",
        repo_name: "agent-core",
        category: "bugfix",
        title: "Fix memory leak in background worker",
        problem: "The worker process was consuming increasing RAM over long execution periods.",
        approach: "Identified a circular reference in the Task object. Implemented weak references for parent links.",
        created_at: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString(),
        technologies: ["Rust", "Tokio"],
        diagram: "Task -> (strong) -> Context -> (strong) -> Task [LEAK]\n\nFix:\nTask -> (strong) -> Context -> (weak) -> Task"
      }
    ];

    function stringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      const h = Math.abs(hash) % 360;
      return `hsl(${h}, 70%, 45%)`;
    }

    function cleanTitle(title) {
      if (!title) return '';
      let cleaned = title.replace(/^(feat|chore|docs|fix|refactor|style|test|perf|ci|build)(\(.*\))?!?:?\s*/i, '');
      return cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Highlighting function
    function highlightText(text, query) {
      if (!query || !text) return escapeHtml(text);
      const output = escapeHtml(text);
      try {
        const pattern = new RegExp(`(${query.replace(/[.*+?^$\{ ()|[\]\\]/g, '\\$&')})`, 'gi');
        return output.replace(pattern, '<span class="highlight">$1</span>');
      } catch (e) {
        return output;
      }
    }

    function timeSince(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm';
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + 'h';
      const days = Math.floor(hours / 24);
      return days + 'd';
    }

    async function init() {
      try {
        const [statsRes, storiesRes] = await Promise.all([
          fetch('/api/status'),
          fetch('/api/stories')
        ]);
        const stats = await statsRes.json();
        document.getElementById('status-text').innerText = `${stats.count} stories · ${stats.repos} repos`;
        const data = await storiesRes.json();
        allStories = data.stories;
      } catch (e) {
        allStories = MOCK_STORIES;
        document.getElementById('status-text').innerText = `${allStories.length} stories · Demo Mode`;
      }
      renderRepoTabs();
      filterAndRenderStories();

      // Search Event Listener
      document.getElementById('search-input').addEventListener('input', (e) => {
        searchQuery = e.target.value.trim().toLowerCase();
        filterAndRenderStories();
      });
    }

    function renderRepoTabs() {
      const repos = {};
      allStories.forEach(s => {
        const name = s.repo_name || 'unknown';
        repos[name] = (repos[name] || 0) + 1;
      });
      const tabs = document.getElementById('repo-tabs');
      let html = `<div class="repo-tab active" data-repo="all">All</div>`;
      Object.entries(repos).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
        html += `<div class="repo-tab" data-repo="${name}">${name}</div>`;
      });
      tabs.innerHTML = html;
      tabs.querySelectorAll('.repo-tab').forEach(tab => {
        tab.onclick = () => {
          tabs.querySelectorAll('.repo-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentRepo = tab.dataset.repo;
          filterAndRenderStories();
        };
      });
    }

    function filterAndRenderStories() {
      let filtered = allStories;

      // Repo filter
      if (currentRepo !== 'all') {
        filtered = filtered.filter(s => s.repo_name === currentRepo);
      }

      // Search filter
      if (searchQuery) {
        filtered = filtered.filter(s => {
          const searchStr = [
            s.title,
            s.repo_name,
            s.category,
            s.problem,
            s.approach,
            ...(s.technologies || []),
            ...(s.files || [])
          ].join(' ').toLowerCase();
          return searchStr.includes(searchQuery);
        });
      }

      renderStories(filtered);
    }

    function renderStories(stories) {
      const feed = document.getElementById('feed');
      if (!stories || !stories.length) {
        feed.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-secondary)">
              ${searchQuery ? `No matches for "${searchQuery}"` : 'No stories found'}
          </div>`;
        return;
      }

      feed.innerHTML = stories.map(s => {
        const timeStr = timeSince(new Date(s.started_at || s.created_at));
        const category = s.category || 'chore';
        const repoName = s.repo_name || 'cli';

        // Use highlighting
        const displayTitle = highlightText(cleanTitle(s.title), searchQuery);
        const displayProblem = s.problem ? highlightText(s.problem, searchQuery) : '';
        const displayApproach = s.approach ? highlightText(s.approach, searchQuery) : '';
        const displayRepo = highlightText(repoName, searchQuery);

        const avatarColor = stringToColor(repoName);
        const avatarLetter = repoName.substring(0, 2).toUpperCase();

        const techHtml = (s.technologies && s.technologies.length) ?
          `<div class="skills-inline">${s.technologies.slice(0, 3).map(t => `<span class="skill-tag">${highlightText(t, searchQuery)}</span>`).join('')}</div>` : '';

        return `
          <div class="post" id="post-${s.id}" onclick="openStory(event, '${s.id}')">
            <div class="post-content">
              <div class="post-header">
                <span class="name">r/${displayRepo}</span>
                <span class="category ${category}">${category}</span>
                <span class="time">${timeStr}</span>
                ${techHtml}
              </div>
              <div class="post-title">${displayTitle}</div>
              ${displayProblem ? `<div class="post-problem">${displayProblem}</div>` : ''}
              ${displayApproach ? `<div class="post-approach">${displayApproach}</div>` : ''}
              ${s.diagram ? `<div class="diagram-block"><pre>${escapeHtml(s.diagram)}</pre></div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function goBack() {
      document.getElementById('view-feed').style.display = 'block';
      document.getElementById('view-detail').style.display = 'none';
      if (window.lastScrollY) window.scrollTo(0, window.lastScrollY);
    }

    function openStory(event, storyId) {
      const story = allStories.find(s => s.id === storyId);
      if (!story) return;

      window.lastScrollY = window.scrollY; // Save scroll position
      document.getElementById('view-feed').style.display = 'none';
      document.getElementById('view-detail').style.display = 'block';
      window.scrollTo(0, 0);

      const contentEl = document.getElementById('detail-content');
      const timeStr = timeSince(new Date(story.started_at || story.created_at));
      const category = story.category || 'update';
      const repoName = story.repo_name || 'cli';
      const displayTitle = cleanTitle(story.title);

      const techHtml = (story.technologies && story.technologies.length) ?
        `<div class="skills-inline">${story.technologies.map(t => `<span class="skill-tag">${escapeHtml(t)}</span>`).join('')}</div>` : '';

      const showHtml = story.show ? `<div class="snippet-block" style="margin-top:16px"><div class="snippet-header">Output</div><div class="snippet-code"><pre>${escapeHtml(story.show)}</pre></div></div>` : '';

      const diagramHtml = story.diagram ? `<div class="diagram-block"><pre>${escapeHtml(story.diagram)}</pre></div>` : '';

      const filesHtml = (story.files && story.files.length) ?
        `<div class="section-subtitle">Files Touched</div>
         <div class="files-row">
           ${story.files.map(f => `<span class="file-tag">${escapeHtml(f.split('/').pop())}</span>`).join('')}
         </div>` : '';

      const snippetsHtml = (story.key_snippets && story.key_snippets.length) ?
        `<div class="section-subtitle">Key Snippets</div>
         ${story.key_snippets.map(s => `
           <div class="snippet-block">
             <div class="snippet-header">${escapeHtml(s.file_path)}</div>
             <div class="snippet-code"><pre>${escapeHtml(s.content)}</pre></div>
           </div>
         `).join('')}` : '';

      // Support for file_changes if it exists as a list of objects
      const fileChangesHtml = (story.file_changes && story.file_changes.length) ?
        `<div class="section-subtitle">File Changes</div>
         <ul style="padding-left:16px; color:var(--text-secondary); font-size:15px; margin-bottom: 24px; list-style: none;">
           ${story.file_changes.map(ch => {
          const path = ch.file_path || ch.path || 'unknown';
          const changeType = ch.change_type || 'modified';
          const insertions = ch.insertions || 0;
          const deletions = ch.deletions || 0;
          const stats = [];
          if (insertions > 0) stats.push(`<span style="color: var(--green);">+${insertions}</span>`);
          if (deletions > 0) stats.push(`<span style="color: var(--red);">-${deletions}</span>`);
          const statsStr = stats.length > 0 ? stats.join('/') : '0 changes';
          return `<li style="margin-bottom: 4px; font-family: var(--font-mono); font-size: 13px;">
               <span style="color: var(--text-muted);">[${changeType}]</span> ${escapeHtml(path.split('/').pop())}
               <span style="margin-left: 8px; font-size: 12px;">${statsStr}</span>
             </li>`;
        }).join('')}
         </ul>` : '';

      const avatarColor = stringToColor(repoName);
      const avatarLetter = repoName.substring(0, 2).toUpperCase();

      contentEl.innerHTML = `
        <div class="post" style="border-bottom: 0; cursor: default; padding: 16px;">
            <div class="post-content">
                <div class="post-header">
                  <span class="name">r/${repoName}</span>
                  <span class="category ${category}">${category}</span>
                  <span class="time">${timeStr}</span>
                  ${techHtml}
                </div>
                <div class="post-title" style="font-size: 24px;">${escapeHtml(displayTitle)}</div>
                ${story.problem ? `<div class="post-problem" style="font-size: 16px; margin-bottom:12px;">${escapeHtml(story.problem)}</div>` : ''}
                ${story.approach ? `<div class="post-approach" style="font-size: 16px;">${escapeHtml(story.approach)}</div>` : ''}
                
                ${showHtml}
                ${diagramHtml}
                
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 32px 0;">
                
                ${story.lessons && story.lessons.length ? `
                  <div class="insight-box">
                    <div class="insight-label">Transferable Insight</div>
                    ${story.lessons.map(l => `<div class="insight-text">${escapeHtml(l)}</div>`).join('')}
                  </div>
                ` : ''}

                ${story.implementation_details && story.implementation_details.length ? `
                   <div class="section-subtitle">Implementation Details</div>
                   <ul style="padding-left:16px; color:var(--text-secondary); font-size:15px; line-height:1.6; margin-bottom: 24px;">
                     ${story.implementation_details.map(d => `<li>${escapeHtml(d)}</li>`).join('')}
                   </ul>
                ` : ''}

                ${filesHtml}
                ${snippetsHtml}
                ${fileChangesHtml}
            </div>
          </div>
      `;
    }

    init();
  </script>
</body>

</html>