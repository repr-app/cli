<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repr Timeline</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Spectral:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap"
    rel="stylesheet">
  <style>
:root {
  /* Substack-inspired warm palette - Light (default) */
  --bg: #f9f7f4;
  --surface: #ffffff;
  --surface-hover: #f8fafc;
  --surface-card: #ffffff;
  --border: #eaecf0;
  --text-primary: #111827;
  --text-secondary: #4b5563;
  --text-muted: #9ca3af;
  --accent: #FF5A1F;
  /* Substack Orange-ish */
  --accent-hover: #e04f1a;
  --green: #16a34a;
  --red: #dc2626;
  --font-mono: 'JetBrains Mono', 'Monaco', monospace;
  --font-serif: 'Spectral', 'Georgia', serif;
}

/* Dark theme */
[data-theme="dark"] {
  --bg: #0d1117;
  --surface: #161b22;
  --surface-hover: #21262d;
  --surface-card: #0d1117;
  --border: #30363d;
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-muted: #6e7681;
  --accent: #ff7a33;
  --accent-hover: #ff8f52;
  --green: #3fb950;
  --red: #f85149;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  line-height: 1.4;
}

/* Dashboard Layout */
.dashboard {
  display: flex;
  min-height: 100vh;
}

/* Main Content */
.main-content {
  flex: 1;
  margin-left: 240px;
  min-height: 100vh;
  background: var(--bg);
  transition: margin-left 0.3s ease;
}

.content-header {
  padding: 28px 32px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  position: sticky;
  top: 0;
  z-index: 50;
  display: flex;
  flex-direction: column;
}

.mobile-menu-toggle {
  display: none;
  font-size: 24px;
  cursor: pointer;
  margin-bottom: 12px;
  width: fit-content;
}

.content-header h1 {
  font-family: var(--font-serif);
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.02em;
}

.content-header-subtitle {
  font-size: 14px;
  color: var(--text-muted);
  margin-top: 4px;
}

.content-body {
  padding: 0;
}

/* Legacy container for detail view */
.container {
  max-width: 800px;
  margin: 0 auto;
  min-height: 100vh;
  background: #fff;
}

/* Feed container */
.feed-container {
  max-width: 680px;
  margin: 0 auto;
}

/* Settings container */
.settings-container {
  max-width: 700px;
  margin: 0 auto;
}

.loading-text {
  color: var(--text-muted);
  font-size: 14px;
  padding: 20px;
  text-align: center;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
}

.empty-state-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }

  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.post {
  padding: 28px 24px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
  background: var(--surface);
  animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Detail View Overlay */
#view-detail {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 200;
  background: var(--bg);
  display: none;
}

#view-detail.open {
  display: flex;
}

#view-detail .sidebar {
  position: relative;
  height: 100%;
}

#view-detail .main-content {
  margin-left: 0;
}

/* Profile View Overlay */
#view-profile {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 200;
  background: var(--bg);
  display: none;
}

#view-profile.open {
  display: flex;
}

#view-profile .sidebar {
  position: relative;
  height: 100%;
}

#view-profile .main-content {
  margin-left: 0;
}

.mobile-nav {
  display: none;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .main-content {
    margin-left: 0 !important;
  }

  .content-header {
    padding: 16px 20px;
  }

  .date-header {
    padding: 16px 20px 8px;
  }

  .date-header::before {
    left: 20px;
    right: 20px;
  }

  .mobile-menu-toggle {
    display: block;
  }

  .feed-container,
  .settings-container {
    padding: 0 10px;
  }

  .feed-wrapper {
    border-left: none;
    border-right: none;
  }

  .post-card {
    padding: 12px 16px;
  }

  .post-avatar {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }

  .post-text {
    font-size: 15px;
  }

  .post-actions {
    max-width: 100%;
  }

  .date-header {
    padding: 10px 16px;
    top: 0;
  }

  .tabs-bar {
    flex-direction: column;
    align-items: flex-start;
    padding: 10px 16px;
    gap: 12px;
  }

  .search-container {
    width: 100%;
    margin-left: 0;
  }

  .search-input {
    flex: 1;
    width: 100% !important;
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: 90;
  }

  .sidebar-overlay.open {
    display: block;
  }

  .mobile-nav {
    display: flex;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 64px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    z-index: 100;
    justify-content: space-around;
    align-items: center;
    padding-bottom: env(safe-area-inset-bottom);
  }

  .mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--text-muted);
    cursor: pointer;
  }

  .mobile-nav-item.active {
    color: var(--accent);
  }

  .mobile-nav-item span:first-child {
    font-size: 20px;
  }

  body {
    padding-bottom: 64px;
    /* Space for mobile nav */
  }
}

/* Touch targets */
.btn,
.sidebar-item,
.repo-tab,
.repo-action-btn {
  min-height: 44px;
  display: flex;
  align-items: center;
}

/* Date Headers */
.date-header {
  padding: 12px 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 56px;
  z-index: 40;
  backdrop-filter: blur(12px);
  background: rgba(255, 255, 255, 0.85);
}

[data-theme="dark"] .date-header {
  background: rgba(22, 27, 34, 0.85);
}

.date-header-label {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
}
/* Sidebar */
.sidebar {
  width: 240px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  z-index: 100;
}

.sidebar-header {
  padding: 20px 16px;
  border-bottom: 1px solid var(--border);
}

.sidebar-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-avatar {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: var(--green);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
  color: white;
}

.sidebar-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
}

.sidebar-subtitle {
  font-size: 11px;
  color: var(--text-muted);
}

.sidebar-nav {
  flex: 1;
  padding: 12px 8px;
}

.sidebar-section {
  margin-bottom: 24px;
}

.sidebar-section-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 8px 12px 8px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
  margin-bottom: 2px;
}

.sidebar-item:hover {
  background: var(--surface-hover);
  color: var(--text-primary);
}

.sidebar-item.active {
  background: var(--accent);
  color: white;
}

.sidebar-item.active .sidebar-icon {
  color: white;
}

.sidebar-icon {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: var(--text-muted);
}

.sidebar-footer {
  padding: 16px;
  border-top: 1px solid var(--border);
}

.theme-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  margin-bottom: 12px;
  font-size: 13px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: color 0.15s;
}

.theme-toggle:hover {
  color: var(--text-primary);
}

.theme-toggle-icon {
  font-size: 16px;
}

.sidebar-status {
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
}

.status-dot {
  width: 6px;
  height: 6px;
  background: var(--green);
  border-radius: 50%;
}

.sidebar-icon svg {
  width: 18px;
  height: 18px;
  stroke-width: 2px;
}

.mobile-nav-item svg {
  width: 20px;
  height: 20px;
  stroke-width: 2px;
  margin-bottom: 4px;
}

.theme-toggle-compact {
  padding: 6px 12px;
  font-size: 12px;
}

.theme-toggle-compact .sidebar-icon svg {
  width: 14px;
  height: 14px;
}

.mobile-menu-toggle {
  display: none;
  cursor: pointer;
  margin-right: 12px;
  color: var(--text-secondary);
}

.mobile-menu-toggle svg {
  width: 24px;
  height: 24px;
}

/* Tiny Avatar in Feed */
.tiny-avatar {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 700;
  margin-right: 6px;
}

.user-info {
  display: flex;
  align-items: center;
  cursor: pointer;
  margin-right: 4px;
}

.user-info:hover .name {
  text-decoration: underline;
  color: var(--text-primary);
}

/* Profile Header */
.profile-header {
  padding: 24px 16px;
  border-bottom: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(12px);
  z-index: 10;
  position: sticky;
  top: 0;
  display: flex;
  gap: 16px;
}

.profile-avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--green);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 24px;
  color: white;
  flex-shrink: 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.profile-info h1 {
  font-size: 20px;
  font-weight: 800;
  letter-spacing: -0.5px;
  margin-bottom: 2px;
}

.profile-handle {
  font-size: 15px;
  color: var(--text-secondary);
  margin-bottom: 0;
}

.profile-bio {
  font-size: 15px;
  color: var(--text-primary);
  margin-top: 8px;
}

.profile-status {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface-card);
  width: fit-content;
  padding: 4px 12px;
  border-radius: 20px;
}

/* Tabs Bar */
.tabs-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  position: relative;
  min-height: 56px;
  position: sticky;
  top: 0;
  z-index: 50;
}

/* Repo Tabs */
.repo-tabs {
  display: flex;
  gap: 0;
  overflow-x: auto;
  flex: 1;
}

.repo-tab {
  padding: 14px 16px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: all 0.15s;
}

.repo-tab:hover {
  color: var(--text-primary);
}

.repo-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

/* Feed & Post */
.feed-wrapper {
  max-width: 600px;
  margin: 0 auto;
  border-left: 1px solid var(--border);
  border-right: 1px solid var(--border);
  min-height: 100vh;
}

.feed {
  display: flex;
  flex-direction: column;
}

/* Post Card - X Style */
.post-card {
  display: flex;
  gap: 12px;
  padding: 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.2s ease;
  background: var(--surface);
}

.post-card:hover {
  background: var(--surface-hover);
}

.post-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 15px;
  color: white;
  flex-shrink: 0;
}

.post-body {
  flex: 1;
  min-width: 0;
}

.post-header {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 2px;
  font-size: 15px;
  line-height: 1.3;
}

.post-author {
  font-weight: 700;
  color: var(--text-primary);
  cursor: pointer;
}

.post-author:hover {
  text-decoration: underline;
}

.post-handle {
  color: var(--text-muted);
  font-weight: 400;
}

.post-meta-sep {
  color: var(--text-muted);
}

.post-time {
  color: var(--text-muted);
}

.post-time:hover {
  text-decoration: underline;
}

.post-title {
  font-weight: 400;
  font-size: 15px;
  margin: 0 0 4px 0;
  line-height: 1.4;
  color: var(--text-primary);
}

.post-text {
  color: var(--text-primary);
  font-size: 15px;
  line-height: 1.5;
  margin: 0;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.post-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 8px;
}

.hashtag {
  font-size: 15px;
  color: var(--accent);
  font-weight: 400;
}

.hashtag:hover {
  text-decoration: underline;
}

.post-actions {
  display: flex;
  justify-content: space-between;
  max-width: 400px;
  margin-top: 12px;
}

.post-action {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-muted);
  font-size: 13px;
  padding: 8px;
  margin: -8px;
  border-radius: 50%;
  transition: all 0.2s;
  cursor: pointer;
}

.post-action:hover {
  color: var(--accent);
  background: rgba(255, 90, 31, 0.1);
}

.post-action svg {
  width: 18px;
  height: 18px;
}

/* Post Media - Diagrams and Output */
.post-media {
  margin-top: 12px;
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
}

.post-diagram,
.post-output {
  margin: 0;
  padding: 12px 16px;
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.5;
  color: var(--text-secondary);
  background: var(--bg);
  white-space: pre;
  overflow-x: auto;
}

.post-output {
  background: #0d1117;
  color: #e6edf3;
}

[data-theme="dark"] .post-diagram {
  background: #161b22;
}

/* Legacy classes for detail view */
.post {
  padding: 24px 0;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}

.post-content {
  flex: 1;
  min-width: 0;
}

.name {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
}

.category {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.category.feature {
  background: #e8f4fd;
  color: #1e6bb8;
}

.category.bugfix {
  background: #fde8e8;
  color: #b91c1c;
}

.category.refactor {
  background: #fef3cd;
  color: #92400e;
}

.category.docs {
  background: #dcfce7;
  color: #15803d;
}

.category.chore {
  background: #f3f4f6;
  color: #4b5563;
}

.category.infra {
  background: #f3e8ff;
  color: #7c3aed;
}

/* Dark mode category badges */
[data-theme="dark"] .category.feature {
  background: rgba(30, 107, 184, 0.2);
  color: #58a6ff;
}

[data-theme="dark"] .category.bugfix {
  background: rgba(185, 28, 28, 0.2);
  color: #f85149;
}

[data-theme="dark"] .category.refactor {
  background: rgba(146, 64, 14, 0.2);
  color: #d29922;
}

[data-theme="dark"] .category.docs {
  background: rgba(21, 128, 61, 0.2);
  color: #3fb950;
}

[data-theme="dark"] .category.chore {
  background: rgba(75, 85, 99, 0.2);
  color: #8b949e;
}

[data-theme="dark"] .category.infra {
  background: rgba(124, 58, 237, 0.2);
  color: #a371f7;
}

.time {
  color: var(--text-muted);
  font-size: 14px;
}

.post-title {
  font-family: var(--font-serif);
  font-weight: 700;
  font-size: 20px;
  margin: 0 0 8px 0;
  line-height: 1.4;
  color: var(--text-primary);
  letter-spacing: -0.01em;
  transition: color 0.15s ease;
}

/* Selected state for keyboard navigation */
.post-card.selected {
  background: var(--surface-hover);
  margin: 0 -16px;
  padding-left: 16px;
  padding-right: 16px;
  border-radius: 8px;
}

/* Skills in Footer */
.skills-inline {
  display: inline-flex;
  flex-wrap: wrap;
  gap: 6px;
}

.skill-tag {
  color: var(--text-muted);
  font-size: 12px;
  font-weight: 500;
}

.skill-tag+.skill-tag::before {
  content: "·";
  margin-right: 6px;
}

.verified-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 14px;
  height: 14px;
  background: var(--accent);
  color: white;
  border-radius: 50%;
  font-size: 9px;
  margin-left: 4px;
  vertical-align: middle;
}

/* Code Blocks */
.diagram-block {
  background: var(--surface-card);
  border-left: 2px solid var(--border);
  padding: 12px 16px;
  margin-top: 12px;
  border-radius: 0 6px 6px 0;
  overflow-x: auto;
}

.diagram-block pre {
  font-family: var(--font-mono);
  font-size: 11px;
  line-height: 1.4;
  color: var(--text-secondary);
  margin: 0;
  white-space: pre;
}

/* Metrics & Insights */
.file-metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
}

.file-metric-card {
  background: var(--surface-card);
  padding: 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
}

.file-name {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 12px;
  word-break: break-all;
}

.metric-row {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  margin-bottom: 4px;
}

.metric-label {
  color: var(--text-muted);
}

.metric-val {
  font-family: var(--font-mono);
}

.insight-box {
  background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
  border-left: 4px solid var(--accent);
  padding: 24px;
  border-radius: 0 8px 8px 0;
  margin-bottom: 24px;
}

[data-theme="dark"] .insight-box {
  background: linear-gradient(135deg, rgba(255, 103, 25, 0.1) 0%, rgba(255, 122, 51, 0.05) 100%);
}

.insight-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 10px;
}

.insight-text {
  font-family: var(--font-serif);
  font-size: 17px;
  line-height: 1.6;
  color: var(--text-primary);
  font-weight: 400;
  font-style: italic;
}

.snippet-block {
  background: #0d1117;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 16px;
  font-family: var(--font-mono);
}

.snippet-header {
  background: #161b22;
  padding: 10px 16px;
  font-size: 13px;
  color: #c9d1d9;
  border-bottom: 1px solid #30363d;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.snippet-code {
  padding: 16px;
  font-size: 13px;
  line-height: 1.6;
  color: #e6edf3;
  overflow-x: auto;
}

.snippet-code pre {
  margin: 0;
  font-family: var(--font-mono);
}

.section-subtitle {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
  margin-top: 16px;
}

/* Search Input */
.search-container {
  display: flex;
  align-items: center;
  margin: 0 auto;
  position: relative;
  width: 100%;
  max-width: 600px;
}

.search-icon {
  position: absolute;
  left: 16px;
  color: var(--text-muted);
  pointer-events: none;
  display: flex;
  align-items: center;
}

.search-input {
  background: var(--bg);
  border: 2px solid var(--border);
  padding: 12px 16px 12px 44px;
  border-radius: 12px;
  font-size: 15px;
  color: var(--text-primary);
  width: 100%;
  outline: none;
  transition: all 0.2s ease;
}

.search-input::placeholder {
  color: var(--text-muted);
}

.search-input:hover {
  border-color: var(--text-muted);
}

.search-input:focus {
  border-color: var(--accent);
  background: var(--surface);
  box-shadow: 0 0 0 4px rgba(255, 122, 51, 0.1);
}

.search-input:focus+.search-shortcut {
  opacity: 0;
}

.search-shortcut {
  position: absolute;
  right: 12px;
  display: flex;
  align-items: center;
  gap: 2px;
  padding: 4px 8px;
  background: var(--surface-hover);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  pointer-events: none;
  transition: opacity 0.15s;
}

.search-shortcut-mod::after {
  content: "⌘";
}

/* Windows/Linux detection via JS adds .is-windows class to body */
body.is-windows .search-shortcut-mod::after {
  content: "Ctrl+";
}

@media (pointer: coarse) {
  .search-shortcut {
    display: none;
  }
}

.highlight {
  background-color: rgba(255, 235, 59, 0.4);
  border-radius: 2px;
  padding: 0 1px;
}

[data-theme="dark"] .highlight {
  background-color: rgba(210, 153, 34, 0.3);
}

/* File Tags */
.files-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 24px;
}

.file-tag {
  background: var(--surface-card);
  border: 1px solid var(--border);
  padding: 4px 10px;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-secondary);
  display: inline-block;
}

/* Settings Styles */
.settings-nav {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  margin: 24px 24px 0;
  border-radius: 8px 8px 0 0;
}

.settings-nav-item {
  padding: 14px 24px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.settings-nav-item:hover {
  color: var(--text-primary);
}

.settings-nav-item.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.settings-content {
  padding: 32px 24px;
  background: var(--surface);
  margin: 0 24px 24px;
  border-radius: 0 0 8px 8px;
  border: 1px solid var(--border);
  border-top: none;
}

/* Standalone settings content (no tabs above) */
.settings-container>.settings-content:first-child {
  margin-top: 24px;
  border-radius: 8px;
  border-top: 1px solid var(--border);
}

.settings-section {
  margin-bottom: 32px;
}

.settings-section-title {
  font-family: var(--font-serif);
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
  letter-spacing: -0.01em;
}

.settings-group {
  margin-bottom: 20px;
}

.settings-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 6px;
}

.settings-hint {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

.settings-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  color: var(--text-primary);
  background: var(--bg);
  transition: border-color 0.2s;
}

.settings-input:focus {
  outline: none;
  border-color: var(--accent);
}

.settings-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  color: var(--text-primary);
  background: var(--bg);
  cursor: pointer;
}

.settings-checkbox-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
}

.settings-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.settings-checkbox-label {
  font-size: 14px;
  color: var(--text-primary);
  cursor: pointer;
}

.settings-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.json-editor {
  width: 100%;
  min-height: 500px;
  padding: 16px;
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.5;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: #0d1117;
  color: #e6edf3;
  resize: vertical;
}

.json-editor:focus {
  outline: none;
  border-color: var(--accent);
}

.btn {
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.btn-primary {
  background: var(--accent);
  color: white;
}

.btn-primary:hover {
  background: var(--accent-hover);
}

.btn-primary:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.btn-secondary {
  background: var(--surface-card);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--surface-hover);
}

.btn-row {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}

.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  z-index: 1000;
  animation: slideIn 0.3s ease;
}

.toast.success {
  background: var(--green);
  color: white;
}

.toast.error {
  background: var(--red);
  color: white;
}

.tags-input {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  min-height: 42px;
  align-items: center;
}

.tag-item {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--surface-card);
  border: 1px solid var(--border);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 13px;
}

.tag-remove {
  cursor: pointer;
  color: var(--text-muted);
  font-size: 16px;
  line-height: 1;
}

.tag-remove:hover {
  color: var(--red);
}

.tags-input input {
  border: none;
  outline: none;
  flex: 1;
  min-width: 100px;
  font-size: 14px;
  background: transparent;
}

/* Repos List */
.repos-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.repo-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
}

.repo-item.paused {
  opacity: 0.6;
}

.repo-item.missing {
  border-color: var(--red);
  background: #fef2f2;
}

.repo-info {
  flex: 1;
  min-width: 0;
}

.repo-name-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.repo-name {
  font-weight: 600;
  font-size: 15px;
  color: var(--text-primary);
  cursor: pointer;
  border-bottom: 1px dashed transparent;
  transition: all 0.15s;
}

.repo-name:hover {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.repo-edit-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 14px;
  padding: 2px 6px;
  border-radius: 4px;
  opacity: 0.4;
  transition: all 0.15s;
}

.repo-name-row:hover .repo-edit-btn {
  opacity: 1;
}

.repo-edit-btn:hover {
  background: var(--surface-hover);
  color: var(--accent);
  opacity: 1;
}

.repo-edit-btn:hover {
  background: var(--surface-hover);
  color: var(--text-primary);
}

.repo-link {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 4px;
  color: var(--text-muted);
  text-decoration: none;
  transition: all 0.15s;
  font-size: 13px;
  line-height: 1;
}

.repo-link:hover {
  color: var(--accent);
  background: var(--surface-hover);
}

.repo-link-icon {
  display: inline-block;
  transform: translateY(-1px);
}

.repo-path {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
  word-break: break-all;
}

.repo-status {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}

.repo-badge {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 500;
}

.repo-badge.active {
  background: #dcfce7;
  color: #15803d;
}

.repo-badge.paused {
  background: #fef3cd;
  color: #92400e;
}

.repo-badge.missing {
  background: #fde8e8;
  color: #b91c1c;
}

.repo-badge.hook {
  background: #e8f4fd;
  color: #1e6bb8;
}

/* Dark mode repo badges */
[data-theme="dark"] .repo-badge.active {
  background: rgba(21, 128, 61, 0.2);
  color: #3fb950;
}

[data-theme="dark"] .repo-badge.paused {
  background: rgba(146, 64, 14, 0.2);
  color: #d29922;
}

[data-theme="dark"] .repo-badge.missing {
  background: rgba(185, 28, 28, 0.2);
  color: #f85149;
}

[data-theme="dark"] .repo-badge.hook {
  background: rgba(30, 107, 184, 0.2);
  color: #58a6ff;
}

.repo-actions {
  display: flex;
  gap: 8px;
}

.repo-action-btn {
  padding: 6px 12px;
  font-size: 12px;
  font-weight: 500;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}

.repo-action-btn:hover {
  background: var(--surface-hover);
  color: var(--text-primary);
}

.repo-action-btn.danger:hover {
  background: #fde8e8;
  border-color: var(--red);
  color: var(--red);
}

/* Cron Status */
.cron-status-box {
  padding: 20px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
}

.cron-status-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.cron-status-label {
  font-size: 14px;
  color: var(--text-secondary);
}

.cron-status-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.cron-status-value.active {
  color: var(--green);
}

.cron-status-value.inactive {
  color: var(--text-muted);
}

.cron-status-value.paused {
  color: #92400e;
}

/* CLI Hints */
.cli-hint {
  margin-bottom: 16px;
}

.cli-hint code {
  display: block;
  font-family: var(--font-mono);
  font-size: 13px;
  background: #1a1a1a;
  color: #e6edf3;
  padding: 12px 16px;
  border-radius: 6px;
  margin-bottom: 6px;
}

/* Skeleton Loaders */
.skeleton {
  background: var(--surface-hover);
  background: linear-gradient(90deg,
      var(--surface-hover) 25%,
      var(--border) 50%,
      var(--surface-hover) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite linear;
  border-radius: 4px;
}

@keyframes shimmer {
  0% {
    background-position: 200% 0;
  }

  100% {
    background-position: -200% 0;
  }
}

.skeleton-card {
  display: flex;
  gap: 12px;
  padding: 20px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
}

.skeleton-card .skeleton-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  flex-shrink: 0;
}

.skeleton-body {
  flex: 1;
}

.skeleton-header {
  height: 14px;
  width: 40%;
  margin-bottom: 8px;
}

.skeleton-title {
  height: 18px;
  width: 80%;
  margin-bottom: 8px;
}

.skeleton-text {
  height: 14px;
  margin-bottom: 6px;
  width: 100%;
}

/* Legacy skeleton styles */
.skeleton-post {
  padding: 28px 24px;
  border-bottom: 1px solid var(--border);
}

.skeleton-avatar {
  width: 20px;
}

/* Timeline Date Grouping - Simple Subtle Style */
.date-header {
  padding: 24px 24px 8px;
  margin-top: 8px;
  border-bottom: 1px solid var(--border);
}

.date-header:first-child {
  margin-top: 0;
  padding-top: 16px;
}

.date-header-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  backdrop-filter: blur(2px);
}

.modal-overlay.open {
  opacity: 1;
  visibility: visible;
}

.modal-container {
  background: var(--surface);
  border-radius: 12px;
  width: 100%;
  max-width: 480px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  transform: translateY(20px);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  border: 1px solid var(--border);
}

.modal-overlay.open .modal-container {
  transform: translateY(0);
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-title {
  font-family: var(--font-serif);
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
  line-height: 1;
  border-radius: 4px;
}

.modal-close:hover {
  background: var(--surface-hover);
  color: var(--text-primary);
}

.modal-body {
  padding: 24px;
}

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: var(--bg);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.editable-field-container {
  position: relative;
  display: flex;
  align-items: center;
}

.editable-field-container .settings-input {
  padding-right: 40px;
}

.editable-field-icon {
  position: absolute;
  right: 12px;
  color: var(--text-muted);
  pointer-events: none;
  font-size: 14px;
}

/* Profile View - New Design */
.profile-container {
  max-width: 600px;
  margin: 0 auto;
  min-height: 100vh;
  background: var(--surface);
  border-left: 1px solid var(--border);
  border-right: 1px solid var(--border);
  position: relative;
}

.profile-header-nav {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid transparent;
  padding: 0 16px;
  height: 53px;
  display: flex;
  align-items: center;
  gap: 20px;
}

[data-theme="dark"] .profile-header-nav {
  background: rgba(13, 17, 23, 0.85);
}

.back-button {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
  color: var(--text-primary);
  margin-left: -8px;
}

.back-button:hover {
  background: var(--surface-hover);
}

.profile-nav-title {
  font-weight: 700;
  font-size: 17px;
  color: var(--text-primary);
}

.profile-cover {
  height: 200px;
  width: 100%;
  background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
  background-size: cover;
  background-position: center;
}

[data-theme="dark"] .profile-cover {
  background: linear-gradient(135deg, #4b2c34 0%, #3e1f2b 100%);
}

.profile-content {
  position: relative;
}

.profile-top-section {
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.profile-avatar-wrapper {
  margin-top: -15%;
  padding: 4px;
  background: var(--surface);
  border-radius: 50%;
  display: inline-block;
}

.profile-avatar-large {
  width: 134px;
  height: 134px;
  border-radius: 50%;
  background: var(--green);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 56px;
  color: white;
  border: 4px solid var(--surface);
  position: relative;
}

.profile-actions {
  display: flex;
  gap: 8px;
}

.btn-sm {
  padding: 6px 16px;
  font-size: 14px;
  border-radius: 20px;
  border-width: 1px;
}

.profile-details {
  padding: 0 16px 16px;
}

.profile-name-row {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 2px;
}

.profile-name-row h1 {
  font-size: 20px;
  font-weight: 800;
  color: var(--text-primary);
  margin: 0;
  line-height: 1.2;
}

.verified-badge-large {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: var(--accent);
  width: 20px;
  height: 20px;
}

.profile-handle {
  font-size: 15px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.profile-bio {
  font-size: 15px;
  color: var(--text-primary);
  line-height: 1.5;
  margin-bottom: 12px;
  white-space: pre-wrap;
}

.profile-metadata-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 12px;
  align-items: center;
}

.profile-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--surface-card);
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
}

.profile-pill:hover {
  background: var(--surface-hover);
  color: var(--text-primary);
  cursor: pointer;
}

.pill-icon {
  font-size: 14px;
}

.profile-pill-count {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
  background: var(--surface-card);
  padding: 4px 12px;
  border-radius: 16px;
}

.profile-stats-row {
  display: flex;
  gap: 20px;
  font-size: 14px;
  color: var(--text-secondary);
}

.stat-item strong {
  color: var(--text-primary);
  font-weight: 700;
}

.profile-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  margin-top: 16px;
}

.profile-tab {
  flex: 1;
  text-align: center;
  padding: 16px 0;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  position: relative;
  transition: all 0.2s;
}

.profile-tab:hover {
  background: var(--surface-hover);
  color: var(--text-primary);
}

.profile-tab.active {
  color: var(--text-primary);
  font-weight: 700;
}

.profile-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 56px;
  height: 4px;
  background: var(--accent);
  border-radius: 2px;
}
  </style>
  
</head>

<body>
  <div class="dashboard" id="view-main">
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-avatar">R</div>
          <div>
            <div class="sidebar-title">Repr</div>
            <div class="sidebar-subtitle">Dashboard</div>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Overview</div>
          <div class="sidebar-item active" data-view="stories" onclick="switchMainView('stories')" role="button"
            aria-label="View Stories">
            <span class="sidebar-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
              </svg>
            </span>
            Stories
          </div>
          <div class="sidebar-item" data-view="repos" onclick="switchMainView('repos')" role="button"
            aria-label="View Repositories">
            <span class="sidebar-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
            </span>
            Repositories
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Configuration</div>
          <div class="sidebar-item" data-view="settings" onclick="switchMainView('settings')" role="button"
            aria-label="Settings">
            <span class="sidebar-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
              </svg>
            </span>
            Settings
          </div>
          <div class="sidebar-item" data-view="llm" onclick="switchMainView('llm')" role="button"
            aria-label="LLM Configuration">
            <span class="sidebar-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1-10-10 10 10 0 0 1 10-10z"></path>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                <line x1="15" y1="9" x2="15.01" y2="9"></line>
              </svg>
            </span>
            LLM
          </div>
          <div class="sidebar-item" data-view="privacy" onclick="switchMainView('privacy')" role="button"
            aria-label="Privacy Settings">
            <span class="sidebar-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            </span>
            Privacy
          </div>
          <div class="sidebar-item" data-view="cron" onclick="switchMainView('cron')" role="button"
            aria-label="Cron Settings">
            <span class="sidebar-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </span>
            Cron
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-status">
          <span class="status-dot"></span>
          <span id="status-text">Loading...</span>
        </div>
        <div class="sidebar-item theme-toggle-compact" id="theme-toggle" onclick="toggleTheme()">
          <span class="sidebar-icon theme-toggle-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </span>
          Toggle Theme
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Stories View -->
      <div id="view-stories">
        <div class="tabs-bar">
          <div class="mobile-menu-toggle" onclick="toggleSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </div>
          <div class="search-container">
            <div class="search-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </div>
            <input type="text" id="search-input" class="search-input" placeholder="Search stories...">
            <kbd class="search-shortcut"><span class="search-shortcut-mod"></span>K</kbd>
          </div>
        </div>
        <div class="feed-wrapper">
          <div class="feed" id="feed"></div>
        </div>
      </div>


      <!-- Settings View (General) -->
      <div id="view-settings" style="display: none;">
        <header class="content-header">
          <div class="mobile-menu-toggle" onclick="toggleSidebar()">☰</div>
          <h1>Settings</h1>
          <div class="content-header-subtitle">General configuration</div>
        </header>
        <div class="content-body">
          <div class="settings-container">
            <nav class="settings-nav">
              <div class="settings-nav-item active" data-tab="form" onclick="switchSettingsTab('form')">Form</div>
              <div class="settings-nav-item" data-tab="json" onclick="switchSettingsTab('json')">JSON</div>
            </nav>

            <!-- Form Tab -->
            <div id="settings-form" class="settings-content">
              <!-- Generation Settings -->
              <div class="settings-section">
                <h3 class="settings-section-title">Generation</h3>

                <div class="settings-row">
                  <div class="settings-group">
                    <label class="settings-label">Commits per Story</label>
                    <input type="number" class="settings-input" id="gen-batch-size" min="1" max="50"
                      oninput="markConfigDirty()">
                    <div class="settings-hint">How many commits to group into a single story</div>
                  </div>
                  <div class="settings-group">
                    <label class="settings-label">Max Commits per Batch</label>
                    <input type="number" class="settings-input" id="gen-max-commits" min="1" max="200"
                      oninput="markConfigDirty()">
                  </div>
                </div>

                <div class="settings-group">
                  <label class="settings-label">Default Template</label>
                  <select class="settings-select" id="gen-template" onchange="markConfigDirty()">
                    <option value="resume">Resume</option>
                    <option value="technical">Technical</option>
                    <option value="narrative">Narrative</option>
                  </select>
                </div>

                <div class="settings-checkbox-row">
                  <input type="checkbox" class="settings-checkbox" id="gen-auto-hook" onchange="markConfigDirty()">
                  <label class="settings-checkbox-label" for="gen-auto-hook">Auto-generate on git hook</label>
                </div>
              </div>

              <!-- Paths Settings -->
              <div class="settings-section">
                <h3 class="settings-section-title">Paths</h3>

                <div class="settings-group">
                  <label class="settings-label">Default Scan Paths</label>
                  <div class="tags-input" id="default-paths-container">
                    <input type="text" placeholder="Add path and press Enter" onkeydown="handlePathInput(event)">
                  </div>
                  <div class="settings-hint">Directories to scan for git repositories</div>
                </div>

                <div class="settings-group">
                  <label class="settings-label">Skip Patterns</label>
                  <div class="tags-input" id="skip-patterns-container">
                    <input type="text" placeholder="Add pattern and press Enter" onkeydown="handlePatternInput(event)">
                  </div>
                  <div class="settings-hint">Directory names to skip when scanning</div>
                </div>
              </div>

              <div class="btn-row">
                <button class="btn btn-primary" onclick="saveConfig()" id="save-btn" disabled>Save Changes</button>
                <button class="btn btn-secondary" onclick="loadConfig()">Reset</button>
              </div>
            </div>

            <!-- JSON Tab -->
            <div id="settings-json" class="settings-content" style="display: none;">
              <div class="settings-group">
                <label class="settings-label">Raw Configuration (JSON)</label>
                <textarea class="json-editor" id="json-editor" oninput="markConfigDirty()"></textarea>
                <div class="settings-hint">Edit the raw JSON configuration. Be careful with syntax.</div>
              </div>
              <div class="btn-row">
                <button class="btn btn-primary" onclick="saveJsonConfig()" id="save-json-btn" disabled>Save
                  JSON</button>
                <button class="btn btn-secondary" onclick="loadConfig()">Reset</button>
                <button class="btn btn-secondary" onclick="formatJson()">Format</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- LLM View -->
      <div id="view-llm" style="display: none;">
        <header class="content-header">
          <div class="mobile-menu-toggle" onclick="toggleSidebar()">☰</div>
          <h1>LLM Configuration</h1>
          <div class="content-header-subtitle">Configure your language model settings</div>
        </header>
        <div class="content-body">
          <div class="settings-container">
            <div class="settings-content">
              <div class="settings-section">
                <h3 class="settings-section-title">Mode</h3>
                <div class="settings-group">
                  <label class="settings-label">Default Mode</label>
                  <select class="settings-select" id="llm-default" onchange="markConfigDirty()">
                    <option value="local">Local (Ollama/LM Studio)</option>
                    <option value="cloud">Cloud (repr.dev)</option>
                    <option value="byok:openai">BYOK: OpenAI</option>
                    <option value="byok:anthropic">BYOK: Anthropic</option>
                    <option value="byok:groq">BYOK: Groq</option>
                    <option value="byok:together">BYOK: Together AI</option>
                  </select>
                  <div class="settings-hint">Choose between local models, cloud service, or bring your own API key</div>
                </div>
              </div>

              <div class="settings-section">
                <h3 class="settings-section-title">Local Provider</h3>
                <div class="settings-row">
                  <div class="settings-group">
                    <label class="settings-label">Provider</label>
                    <select class="settings-select" id="llm-local-provider" onchange="markConfigDirty()">
                      <option value="">Not configured</option>
                      <option value="ollama">Ollama</option>
                      <option value="lmstudio">LM Studio</option>
                      <option value="custom">Custom</option>
                    </select>
                  </div>
                  <div class="settings-group">
                    <label class="settings-label">Model</label>
                    <input type="text" class="settings-input" id="llm-local-model" placeholder="e.g., llama3.2"
                      oninput="markConfigDirty()">
                  </div>
                </div>

                <div class="settings-group">
                  <label class="settings-label">API URL</label>
                  <input type="text" class="settings-input" id="llm-local-url" placeholder="http://localhost:11434/v1"
                    oninput="markConfigDirty()">
                  <div class="settings-hint">Base URL for your local LLM server</div>
                </div>
              </div>

              <div class="btn-row">
                <button class="btn btn-primary" onclick="saveConfig()" id="save-llm-btn" disabled>Save Changes</button>
                <button class="btn btn-secondary" onclick="loadConfig()">Reset</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Privacy View -->
      <div id="view-privacy" style="display: none;">
        <header class="content-header">
          <div class="mobile-menu-toggle" onclick="toggleSidebar()">☰</div>
          <h1>Privacy</h1>
          <div class="content-header-subtitle">Control what data is shared</div>
        </header>
        <div class="content-body">
          <div class="settings-container">
            <div class="settings-content">
              <div class="settings-section">
                <h3 class="settings-section-title">Data Sharing</h3>

                <div class="settings-checkbox-row">
                  <input type="checkbox" class="settings-checkbox" id="privacy-local-only" onchange="markConfigDirty()">
                  <label class="settings-checkbox-label" for="privacy-local-only">Lock to local-only mode (disable
                    cloud)</label>
                </div>

                <div class="settings-checkbox-row">
                  <input type="checkbox" class="settings-checkbox" id="privacy-send-diffs" onchange="markConfigDirty()">
                  <label class="settings-checkbox-label" for="privacy-send-diffs">Send diffs to cloud (more context,
                    less privacy)</label>
                </div>
              </div>

              <div class="settings-section">
                <h3 class="settings-section-title">Redaction</h3>

                <div class="settings-checkbox-row">
                  <input type="checkbox" class="settings-checkbox" id="privacy-redact-paths"
                    onchange="markConfigDirty()">
                  <label class="settings-checkbox-label" for="privacy-redact-paths">Redact absolute paths in cloud
                    requests</label>
                </div>

                <div class="settings-checkbox-row">
                  <input type="checkbox" class="settings-checkbox" id="privacy-redact-emails"
                    onchange="markConfigDirty()">
                  <label class="settings-checkbox-label" for="privacy-redact-emails">Redact author emails</label>
                </div>
              </div>

              <div class="settings-section">
                <h3 class="settings-section-title">Profile</h3>
                <div class="settings-group">
                  <label class="settings-label">Profile Visibility</label>
                  <select class="settings-select" id="privacy-visibility" onchange="markConfigDirty()">
                    <option value="public">Public</option>
                    <option value="unlisted">Unlisted</option>
                    <option value="private">Private</option>
                  </select>
                  <div class="settings-hint">Control who can see your profile on repr.dev</div>
                </div>
              </div>

              <div class="btn-row">
                <button class="btn btn-primary" onclick="saveConfig()" id="save-privacy-btn" disabled>Save
                  Changes</button>
                <button class="btn btn-secondary" onclick="loadConfig()">Reset</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Repos View -->
      <div id="view-repos" style="display: none;">
        <header class="content-header">
          <div class="mobile-menu-toggle" onclick="toggleSidebar()">☰</div>
          <h1>Repositories</h1>
          <div class="content-header-subtitle">Manage tracked repositories</div>
        </header>
        <div class="content-body">
          <div class="settings-container">
            <div class="settings-content">
              <div class="settings-section">
                <h3 class="settings-section-title">Add Repository</h3>
                <div class="settings-group">
                  <label class="settings-label">Repository Path</label>
                  <div style="display: flex; gap: 12px;">
                    <input type="text" class="settings-input" id="add-repo-path" placeholder="~/code/my-project"
                      style="flex: 1;">
                    <button class="btn btn-primary" onclick="addRepoClick()">Add</button>
                  </div>
                  <div class="settings-hint">Path to a git repository to track</div>
                </div>
              </div>

              <div class="settings-section">
                <h3 class="settings-section-title">Tracked Repositories</h3>
                <div id="repos-list" class="repos-list">
                  <div class="loading-text">Loading repositories...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cron View -->
      <div id="view-cron" style="display: none;">
        <header class="content-header">
          <div class="mobile-menu-toggle" onclick="toggleSidebar()">☰</div>
          <h1>Cron</h1>
          <div class="content-header-subtitle">Automated story generation</div>
        </header>
        <div class="content-body">
          <div class="settings-container">
            <div class="settings-content">
              <div class="settings-section">
                <h3 class="settings-section-title">Status</h3>
                <div id="cron-status" class="cron-status-box">
                  <div class="loading-text">Loading cron status...</div>
                </div>
              </div>

              <div class="settings-section">
                <h3 class="settings-section-title">Configuration</h3>
                <div class="settings-row">
                  <div class="settings-group">
                    <label class="settings-label">Interval (hours)</label>
                    <input type="number" class="settings-input" id="cron-interval" min="1" max="24"
                      oninput="markConfigDirty()">
                    <div class="settings-hint">Hours between automatic runs</div>
                  </div>
                  <div class="settings-group">
                    <label class="settings-label">Minimum Commits</label>
                    <input type="number" class="settings-input" id="cron-min-commits" min="1" max="100"
                      oninput="markConfigDirty()">
                    <div class="settings-hint">Min commits to trigger generation</div>
                  </div>
                </div>

                <div class="settings-checkbox-row">
                  <input type="checkbox" class="settings-checkbox" id="cron-installed" onchange="markConfigDirty()">
                  <label class="settings-checkbox-label" for="cron-installed">Cron job installed</label>
                </div>

                <div class="settings-checkbox-row">
                  <input type="checkbox" class="settings-checkbox" id="cron-paused" onchange="markConfigDirty()">
                  <label class="settings-checkbox-label" for="cron-paused">Paused</label>
                </div>
              </div>

              <div class="btn-row">
                <button class="btn btn-primary" onclick="saveConfig()" id="save-cron-btn" disabled>Save Changes</button>
                <button class="btn btn-secondary" onclick="loadConfig()">Reset</button>
              </div>

              <div class="settings-section" style="margin-top: 32px;">
                <h3 class="settings-section-title">CLI Commands</h3>
                <div class="cli-hint">
                  <code>repr cron install --interval 4 --min-commits 3</code>
                  <div class="settings-hint">Install cron job with custom settings</div>
                </div>
                <div class="cli-hint">
                  <code>repr cron pause</code> / <code>repr cron resume</code>
                  <div class="settings-hint">Pause or resume the cron job</div>
                </div>
                <div class="cli-hint">
                  <code>repr cron remove</code>
                  <div class="settings-hint">Remove the cron job entirely</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Mobile Bottom Nav -->
    <nav class="mobile-nav">
      <div class="mobile-nav-item active" onclick="switchMainView('stories')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
        <span>Stories</span>
      </div>
      <div class="mobile-nav-item" onclick="switchMainView('repos')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>Repos</span>
      </div>
      <div class="mobile-nav-item" onclick="switchMainView('settings')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
          </path>
        </svg>
        <span>Settings</span>
      </div>
    </nav>
  </div>

  <!-- Detail View (overlay) -->
  <div class="dashboard" id="view-detail">
    <aside class="sidebar" style="background: var(--surface);">
      <div class="sidebar-header">
        <div class="sidebar-logo" style="cursor: pointer;" onclick="goBack()">
          <span style="display: flex; align-items: center; margin-right: 8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
          </span>
          <div>
            <div class="sidebar-title">Back</div>
            <div class="sidebar-subtitle">to stories</div>
          </div>
        </div>
      </div>
    </aside>
    <main class="main-content">
      <div class="content-body">
        <div id="detail-content" style="padding: 24px; max-width: 800px; margin: 0 auto;"></div>
      </div>
    </main>
  </div>

  <!-- Profile View (overlay) -->
  <div class="dashboard" id="view-profile">
    <div class="profile-container">
      <div class="profile-header-nav">
        <div class="back-button" onclick="goBack()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
        </div>
        <div class="profile-nav-title" id="profile-nav-name">Profile</div>
      </div>

      <div class="profile-cover" id="profile-cover"></div>

      <div class="profile-content">
        <div class="profile-top-section">
          <div class="profile-avatar-wrapper">
            <div class="profile-avatar-large" id="profile-view-avatar">R</div>
          </div>
          <div class="profile-actions">
            <!-- Placeholders for future actions like Follow/Message if needed -->
            <!-- <button class="btn btn-secondary btn-sm">Message</button> -->
            <!-- <button class="btn btn-primary btn-sm">Subscribe</button> -->
          </div>
        </div>

        <div class="profile-details">
          <div class="profile-name-row">
            <h1 id="profile-view-name">Repo Name</h1>
            <span class="verified-badge-large" id="profile-verified-badge" style="display:none">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
              </svg>
            </span>
          </div>
          <div class="profile-handle" id="profile-view-handle">@repo</div>

          <div class="profile-bio" id="profile-view-bio">
            Repository timeline and activity.
          </div>

          <div class="profile-metadata-row">
            <div class="profile-pill">
              <span class="pill-icon">📦</span>
              <span id="profile-repo-link">Repository</span>
            </div>
            <div class="profile-pill">
              <span class="pill-icon">🔗</span>
              <span id="profile-web-link">Website</span>
            </div>
            <div class="profile-pill-count" id="profile-stats-count">+2</div>
          </div>

          <div class="profile-stats-row">
            <span class="stat-item"><strong id="profile-stories-count">0</strong> <span
                class="stat-label">Stories</span></span>
            <span class="stat-item"><strong id="profile-commits-count">0</strong> <span
                class="stat-label">Commits</span></span>
            <span class="stat-item"><strong id="profile-contributors-count">0</strong> <span
                class="stat-label">Contributors</span></span>
          </div>
        </div>

        <div class="profile-tabs">
          <div class="profile-tab active">Activity</div>
          <div class="profile-tab">Posts</div>
          <div class="profile-tab">Likes</div>
          <div class="profile-tab">Reads</div>
        </div>

        <div class="feed-container" style="padding-top: 0;">
          <div class="feed" id="profile-feed"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Repo Modal -->
  <div class="modal-overlay" id="edit-repo-modal" onclick="if(event.target === this) closeModal('edit-repo-modal')">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Edit Repository</h3>
        <button class="modal-close" onclick="closeModal('edit-repo-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-group">
          <label class="settings-label">Project Name</label>
          <div class="editable-field-container">
            <input type="text" class="settings-input" id="edit-repo-name-input" placeholder="Project Name"
              onkeydown="if(event.key === 'Enter') saveRepoEdit()">
            <span class="editable-field-icon">✎</span>
          </div>
          <div class="settings-hint">This name will be used in the timeline and stories</div>
        </div>
        <div class="settings-group">
          <label class="settings-label">Path</label>
          <input type="text" class="settings-input" id="edit-repo-path-input" readonly
            style="background: var(--surface-hover); color: var(--text-muted); cursor: not-allowed;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('edit-repo-modal')">Cancel</button>
        <button class="btn btn-primary" id="save-repo-btn" onclick="saveRepoEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
/**
 * Utility Functions
 * Contains helper functions for string manipulation, colors, and formatting
 */

/**
 * Generate a color from a string hash
 */
function stringToColor(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  const h = Math.abs(hash) % 360;
  return `hsl(${h}, 70%, 45%)`;
}

/**
 * Clean conventional commit prefixes from titles
 */
function cleanTitle(title) {
  if (!title) return '';
  let cleaned = title.replace(/^(feat|chore|docs|fix|refactor|style|test|perf|ci|build)(\(.*\))?!?:?\s*/i, '');
  return cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Highlight search query in text
 */
function highlightText(text, query) {
  if (!query || !text) return escapeHtml(text);
  const output = escapeHtml(text);
  try {
    const pattern = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return output.replace(pattern, '<span class="highlight">$1</span>');
  } catch (e) {
    return output;
  }
}

/**
 * Format time difference as human-readable string
 */
function timeSince(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  if (seconds < 60) return 'Just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return minutes + 'm';
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return hours + 'h';
  const days = Math.floor(hours / 24);
  return days + 'd';
}

/**
 * Show toast notification
 */
function showToast(message, type = 'success') {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => toast.remove(), 3000);
}

/**
 * Toggle mobile sidebar
 */
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.querySelector('.sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('open');
}

/**
 * Request notification permission
 */
function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

/**
 * Show browser notification
 */
function notify(title, options = {}) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, options);
  }
}

// Expose functions to global scope for inline onclick handlers
window.toggleSidebar = toggleSidebar;

/**
 * Open a modal by ID
 */
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('open');
    document.body.style.overflow = 'hidden'; // Prevent scrolling
  }
}

/**
 * Close a modal by ID
 */
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('open');
    document.body.style.overflow = ''; // Restore scrolling
  }
}

window.openModal = openModal;
window.closeModal = closeModal;


/**
 * API Module
 * Handles all API calls with error handling and retry logic
 */

const API_BASE = '';

/**
 * Fetch with error handling and retry logic
 */
async function fetchWithRetry(url, options = {}, retries = 2) {
  for (let i = 0; i <= retries; i++) {
    try {
      const response = await fetch(url, options);
      if (!response.ok && i < retries) {
        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        continue;
      }
      return response;
    } catch (error) {
      if (i === retries) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}

/**
 * Get dashboard status
 */
async function getStatus() {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/status`);
    return await response.json();
  } catch (error) {
    console.error('Failed to fetch status:', error);
    throw error;
  }
}

/**
 * Get all stories
 */
async function getStories() {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/stories`);
    return await response.json();
  } catch (error) {
    console.error('Failed to fetch stories:', error);
    throw error;
  }
}

/**
 * Get configuration
 */
async function getConfig() {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/config`);
    return await response.json();
  } catch (error) {
    console.error('Failed to fetch config:', error);
    throw error;
  }
}

/**
 * Update configuration
 */
async function updateConfig(config) {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/config`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(config)
    });

    if (!response.ok) {
      throw new Error('Failed to save config');
    }

    return await response.json();
  } catch (error) {
    console.error('Failed to update config:', error);
    throw error;
  }
}

/**
 * Get repositories
 */
async function getRepos() {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/repos`);
    return await response.json();
  } catch (error) {
    console.error('Failed to fetch repos:', error);
    throw error;
  }
}

/**
 * Add a repository
 */
async function addRepo(path) {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/repos/add`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path })
    });
    return await response.json();
  } catch (error) {
    console.error('Failed to add repo:', error);
    throw error;
  }
}

/**
 * Remove a repository
 */
async function removeRepo(path) {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/repos/remove`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path })
    });
    return await response.json();
  } catch (error) {
    console.error('Failed to remove repo:', error);
    throw error;
  }
}

/**
 * Pause a repository
 */
async function pauseRepo(path) {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/repos/pause`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path })
    });
    return await response.json();
  } catch (error) {
    console.error('Failed to pause repo:', error);
    throw error;
  }
}

/**
 * Resume a repository
 */
async function resumeRepo(path) {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/repos/resume`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path })
    });
    return await response.json();
  } catch (error) {
    console.error('Failed to resume repo:', error);
    throw error;
  }
}

/**
 * Rename a repository's project
 */
async function renameRepo(path, name) {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/repos/rename`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path, name })
    });
    return await response.json();
  } catch (error) {
    console.error('Failed to rename repo:', error);
    throw error;
  }
}

/**
 * Get cron status
 */
async function getCronStatus() {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/cron`);
    return await response.json();
  } catch (error) {
    console.error('Failed to fetch cron status:', error);
    throw error;
  }
}

/**
 * Trigger story generation
 */
async function triggerGeneration() {
  try {
    const response = await fetchWithRetry(`${API_BASE}/api/generate`, {
      method: 'POST'
    });
    return await response.json();
  } catch (error) {
    console.error('Failed to trigger generation:', error);
    throw error;
  }
}


/**
 * State Management
 * Centralized state management with subscriber pattern for reactive updates
 */

class State {
  constructor() {
    this.state = {
      stories: [],
      repos: [],
      config: null,
      cronStatus: null,
      currentRepo: 'all',
      searchQuery: '',
      currentMainView: 'stories',
      currentSettingsTab: 'form',
      configDirty: false,
      previousView: 'view-main'
    };
    this.subscribers = [];
  }

  /**
   * Get current state
   */
  get(key) {
    if (key) {
      return this.state[key];
    }
    return this.state;
  }

  /**
   * Update state and notify subscribers
   */
  update(key, value) {
    const oldValue = this.state[key];
    this.state[key] = value;

    // Notify subscribers with the changed key
    this.subscribers.forEach(fn => fn(key, value, oldValue));
  }

  /**
   * Batch update multiple state values
   */
  batchUpdate(updates) {
    Object.entries(updates).forEach(([key, value]) => {
      this.state[key] = value;
    });

    // Notify subscribers once with all changes
    this.subscribers.forEach(fn => fn('batch', updates, null));
  }

  /**
   * Subscribe to state changes
   */
  subscribe(fn) {
    this.subscribers.push(fn);

    // Return unsubscribe function
    return () => {
      const index = this.subscribers.indexOf(fn);
      if (index > -1) {
        this.subscribers.splice(index, 1);
      }
    };
  }

  /**
   * Reset state to initial values
   */
  reset() {
    this.state = {
      stories: [],
      repos: [],
      config: null,
      cronStatus: null,
      currentRepo: 'all',
      searchQuery: '',
      currentMainView: 'stories',
      currentSettingsTab: 'form',
      configDirty: false,
      previousView: 'view-main'
    };
    this.subscribers.forEach(fn => fn('reset', this.state, null));
  }
}

// Create global state instance
const store = new State();

/**
 * Router to handle browser history
 */
store.initRouter = function () {
  window.addEventListener('popstate', (event) => {
    const state = event.state;
    if (!state) {
      // Default state
      store.update('currentMainView', 'stories');
      switchMainView('stories', false); // false = don't push state
      closeOverlays();
      return;
    }

    if (state.view === 'detail' && state.storyId) {
      // Open story detail without pushing state
      const stories = store.get('stories');
      const story = stories.find(s => s.id === state.storyId);
      if (story) openStory(null, state.storyId, false);
    } else if (state.view === 'profile' && state.repoName) {
      // Open profile without pushing state
      openProfile(null, state.repoName, false);
    } else if (state.view === 'main') {
      // Switch main view without pushing state
      closeOverlays();
      if (state.mainView) {
        switchMainView(state.mainView, false);
      }
    }
  });

  // Handle initial load if needed (e.g. deep linking can be added here later)
};

store.pushHistory = function (state, title, url) {
  history.pushState(state, title, url);
};

function closeOverlays() {
  document.getElementById('view-detail').classList.remove('open');
  document.getElementById('view-profile').classList.remove('open');
  document.getElementById('view-main').style.display = 'flex';
}


/**
 * Theme Module
 * Handles dark/light mode with system preference detection and localStorage persistence
 */

const THEME_KEY = 'repr-dashboard-theme';

/**
 * Initialize theme on page load
 * Respects prefers-color-scheme if no saved preference
 */
function initTheme() {
  const savedTheme = localStorage.getItem(THEME_KEY);

  if (savedTheme) {
    setTheme(savedTheme);
  } else {
    // Check system preference
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }

  // Listen for system theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem(THEME_KEY)) {
      setTheme(e.matches ? 'dark' : 'light');
    }
  });
}

/**
 * Set theme to dark or light
 */
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  updateThemeToggleIcon(theme);
}

/**
 * Toggle between dark and light themes
 */
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

  setTheme(newTheme);
  localStorage.setItem(THEME_KEY, newTheme);
  showToast(`${newTheme === 'dark' ? 'Dark' : 'Light'} mode enabled`, 'success');
}

/**
 * Get current theme
 */
function getTheme() {
  return document.documentElement.getAttribute('data-theme') || 'light';
}

/**
 * Update theme toggle button icon
 */
function updateThemeToggleIcon(theme) {
  const toggle = document.getElementById('theme-toggle');
  if (toggle) {
    const icon = toggle.querySelector('.theme-toggle-icon');
    if (icon) {
      icon.textContent = theme === 'dark' ? '☀' : '☾';
    }
  }
}

// Expose functions to global scope for inline onclick handlers
window.toggleTheme = toggleTheme;


/**
 * Keyboard Navigation Module
 * Provides vim-style keyboard shortcuts for power users
 */

let selectedStoryIndex = -1;
let keyboardShortcutsVisible = false;

/**
 * Initialize keyboard navigation
 */
function initKeyboard() {
  document.addEventListener('keydown', handleKeydown);
}

/**
 * Handle keyboard events
 */
function handleKeydown(e) {
  // ⌘K / Ctrl+K to focus search (works from anywhere)
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    focusSearch();
    return;
  }

  // Don't intercept when typing in inputs
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    if (e.key === 'Escape') {
      e.target.blur();
      return;
    }
    return;
  }

  // Don't intercept if modal is open
  if (keyboardShortcutsVisible) {
    if (e.key === 'Escape' || e.key === '?') {
      hideKeyboardShortcuts();
      e.preventDefault();
    }
    return;
  }

  switch (e.key) {
    case '/':
      e.preventDefault();
      focusSearch();
      break;
    case 'j':
      e.preventDefault();
      selectNextStory();
      break;
    case 'k':
      e.preventDefault();
      selectPreviousStory();
      break;
    case 'Enter':
      if (selectedStoryIndex >= 0) {
        e.preventDefault();
        openSelectedStory();
      }
      break;
    case 'Escape':
      e.preventDefault();
      handleEscape();
      break;
    case 'r':
    case 'R':
      e.preventDefault();
      refreshStories();
      break;
    case '?':
      e.preventDefault();
      showKeyboardShortcuts();
      break;
  }
}

/**
 * Focus the search input
 */
function focusSearch() {
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.focus();
    showToast('Search focused (type to filter, Esc to clear)', 'success');
  }
}

/**
 * Select the next story in the feed
 */
function selectNextStory() {
  const stories = getVisibleStories();
  if (!stories.length) return;

  selectedStoryIndex = Math.min(selectedStoryIndex + 1, stories.length - 1);
  highlightSelectedStory(stories);
}

/**
 * Select the previous story in the feed
 */
function selectPreviousStory() {
  const stories = getVisibleStories();
  if (!stories.length) return;

  selectedStoryIndex = Math.max(selectedStoryIndex - 1, 0);
  highlightSelectedStory(stories);
}

/**
 * Get visible story elements
 */
function getVisibleStories() {
  return Array.from(document.querySelectorAll('.post-card'));
}

/**
 * Highlight the selected story
 */
function highlightSelectedStory(stories) {
  stories.forEach((story, index) => {
    story.classList.toggle('selected', index === selectedStoryIndex);
    if (index === selectedStoryIndex) {
      story.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });
}

/**
 * Open the currently selected story
 */
function openSelectedStory() {
  const stories = getVisibleStories();
  if (selectedStoryIndex >= 0 && selectedStoryIndex < stories.length) {
    const storyEl = stories[selectedStoryIndex];
    const storyId = storyEl.id.replace('post-', '');
    if (storyId) {
      openStory({ stopPropagation: () => {} }, storyId);
    }
  }
}

/**
 * Handle Escape key - close views, clear search, reset selection
 */
function handleEscape() {
  // Close detail/profile views and go back
  const detailView = document.getElementById('view-detail');
  const profileView = document.getElementById('view-profile');

  if (detailView?.style.display !== 'none' || profileView?.style.display !== 'none') {
    goBack();
    return;
  }

  // Clear search
  const searchInput = document.getElementById('search-input');
  if (searchInput && searchInput.value) {
    searchInput.value = '';
    store.update('searchQuery', '');
    filterAndRenderStories();
    return;
  }

  // Clear selection
  if (selectedStoryIndex >= 0) {
    selectedStoryIndex = -1;
    const stories = getVisibleStories();
    stories.forEach(s => s.classList.remove('selected'));
  }
}

/**
 * Show keyboard shortcuts modal
 */
function showKeyboardShortcuts() {
  if (keyboardShortcutsVisible) return;
  keyboardShortcutsVisible = true;

  const modal = document.createElement('div');
  modal.id = 'keyboard-shortcuts-modal';
  modal.className = 'keyboard-modal';
  modal.innerHTML = `
    <div class="keyboard-modal-backdrop" onclick="hideKeyboardShortcuts()"></div>
    <div class="keyboard-modal-content">
      <div class="keyboard-modal-header">
        <h3>Keyboard Shortcuts</h3>
        <button class="keyboard-modal-close" onclick="hideKeyboardShortcuts()">×</button>
      </div>
      <div class="keyboard-shortcuts-list">
        <div class="shortcut-row">
          <kbd>/</kbd>
          <span>Focus search</span>
        </div>
        <div class="shortcut-row">
          <kbd>j</kbd>
          <span>Next story</span>
        </div>
        <div class="shortcut-row">
          <kbd>k</kbd>
          <span>Previous story</span>
        </div>
        <div class="shortcut-row">
          <kbd>Enter</kbd>
          <span>Open selected story</span>
        </div>
        <div class="shortcut-row">
          <kbd>Esc</kbd>
          <span>Close / Clear search / Reset</span>
        </div>
        <div class="shortcut-row">
          <kbd>r</kbd>
          <span>Refresh stories</span>
        </div>
        <div class="shortcut-row">
          <kbd>?</kbd>
          <span>Show this help</span>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

/**
 * Hide keyboard shortcuts modal
 */
function hideKeyboardShortcuts() {
  const modal = document.getElementById('keyboard-shortcuts-modal');
  if (modal) {
    modal.remove();
    keyboardShortcutsVisible = false;
  }
}


/**
 * Stories Module
 * Handles story rendering and management
 */

// Mock data for demo mode
const MOCK_STORIES = [
  {
    id: "mock-1",
    repo_name: "cli",
    author_name: "mendrika",
    verified: true,
    signature_status: "all_verified",
    signed_count: 3,
    total_commits: 3,
    category: "feature",
    title: "Restore dashboard diff functionality and improve branch suggestions",
    problem: "The dashboard lacked diff visualization, and internal models required refactoring to support better branch suggestions.",
    approach: "Executed a refactor of core data models and synthesis logic to improve code representation, then restored the diff view in the dashboard.",
    created_at: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(),
    technologies: ["Python", "SQLite", "Jinja2"],
    lessons: ["Separating the 'Synthesis' logic from the 'Presentation' logic made the diff rendering 3x faster."],
    files: ["src/dashboard.py", "templates/index.html"],
    implementation_details: [
      "Refactored `DiffGenerator` class to handle binary files gracefully.",
      "Updated Jinja2 templates to loop through file deltas.",
      "Added caching layer for diffs larger than 1MB."
    ],
    key_snippets: [
      {
        file_path: "src/dashboard.py",
        line_count: 15,
        content: "def get_diff(self, file_path):\n    # Check cache first\n    if file_path in self.cache:\n        return self.cache[file_path]\n    \n    # Generate diff\n    diff = git.diff(file_path)\n    return diff"
      }
    ]
  },
  {
    id: "mock-2",
    repo_name: "repr",
    author_name: "johndoe",
    verified: false,
    signature_status: "unsigned",
    signed_count: 0,
    total_commits: 2,
    category: "chore",
    title: "docs: update CLI usage messages for clarity",
    problem: "The previous usage messages were too generic and lacked context for specific arguments.",
    approach: "Updated help strings in Typer/Click definitions to include examples.",
    created_at: new Date(Date.now() - 1000 * 60 * 60 * 5).toISOString(),
    technologies: ["Python", "Typer"],
    files: ["cli/main.py"]
  },
  {
    id: "mock-3",
    repo_name: "agent-core",
    author_name: "alice",
    verified: false,
    signature_status: "partially_signed",
    signed_count: 2,
    total_commits: 4,
    category: "bugfix",
    title: "Fix memory leak in background worker",
    problem: "The worker process was consuming increasing RAM over long execution periods.",
    approach: "Identified a circular reference in the Task object. Implemented weak references for parent links.",
    created_at: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString(),
    technologies: ["Rust", "Tokio"],
    diagram: "Task -> (strong) -> Context -> (strong) -> Task [LEAK]\n\nFix:\nTask -> (strong) -> Context -> (weak) -> Task"
  }
];

/**
 * Initialize stories from API or use mock data
 */
async function initStories() {
  renderSkeletons();
  try {
    const [stats, storiesData] = await Promise.all([
      getStatus(),
      getStories()
    ]);

    document.getElementById('status-text').innerText = `${stats.count} stories · ${stats.repos} repos`;
    store.update('stories', storiesData.stories);
  } catch (error) {
    console.warn('Using mock data:', error);
    store.update('stories', MOCK_STORIES);
    document.getElementById('status-text').innerText = `${MOCK_STORIES.length} stories · Demo Mode`;
  }

  renderRepoTabs();
  filterAndRenderStories();

  // Initialize router after stories are loaded
  if (store.initRouter) {
    store.initRouter();
  }

  // Handle initial URL query parameter for view
  const urlParams = new URLSearchParams(window.location.search);
  const viewParam = urlParams.get('view');
  if (viewParam && ['stories', 'settings', 'llm', 'privacy', 'repos', 'cron'].includes(viewParam)) {
    switchMainView(viewParam, false); // false = don't push to history
  }
}

/**
 * Render repository tabs
 */
function renderRepoTabs() {
  const tabs = document.getElementById('repo-tabs');
  if (!tabs) return;

  const stories = store.get('stories');
  const repos = {};
  let html = '<div class="repo-tab active" data-repo="all">All</div>';

  Object.entries(repos).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
    html += `<div class="repo-tab" data-repo="${name}">${name}</div>`;
  });

  tabs.innerHTML = html;

  tabs.querySelectorAll('.repo-tab').forEach(tab => {
    tab.onclick = () => {
      tabs.querySelectorAll('.repo-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      store.update('currentRepo', tab.dataset.repo);
      filterAndRenderStories();
    };
  });
}

/**
 * Filter and render stories based on current repo and search query
 */
function filterAndRenderStories() {
  const stories = store.get('stories');
  const currentRepo = store.get('currentRepo');
  const searchQuery = store.get('searchQuery');

  let filtered = stories;

  // Repo filter
  if (currentRepo !== 'all') {
    filtered = filtered.filter(s => s.repo_name === currentRepo);
  }

  // Search filter
  if (searchQuery) {
    filtered = filtered.filter(s => {
      const searchStr = [
        s.title,
        s.repo_name,
        s.category,
        s.problem,
        s.approach,
        ...(s.technologies || []),
        ...(s.files || [])
      ].join(' ').toLowerCase();
      return searchStr.includes(searchQuery);
    });
  }

  renderStories(filtered);
}

/**
 * Get relative date label for a given date
 * Returns: "Today", "Yesterday", "This Week", or formatted date
 */
function getDateLabel(date) {
  const now = new Date();
  const storyDate = new Date(date);

  // Reset times for date comparison
  const nowDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const storyDateOnly = new Date(storyDate.getFullYear(), storyDate.getMonth(), storyDate.getDate());

  const diffDays = Math.floor((nowDate - storyDateOnly) / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return 'This Week';

  // Format as "Jan 15" or "Jan 15, 2024" if different year
  const options = { month: 'short', day: 'numeric' };
  if (storyDate.getFullYear() !== now.getFullYear()) {
    options.year = 'numeric';
  }
  return storyDate.toLocaleDateString('en-US', options);
}

/**
 * Group stories by date
 */
function groupStoriesByDate(stories) {
  const groups = {};

  stories.forEach(story => {
    const date = story.started_at || story.created_at;
    const label = getDateLabel(date);

    if (!groups[label]) {
      groups[label] = [];
    }
    groups[label].push(story);
  });

  // Sort labels: Today, Yesterday, This Week, then chronologically
  const labelOrder = ['Today', 'Yesterday', 'This Week'];
  const sortedLabels = Object.keys(groups).sort((a, b) => {
    const aIndex = labelOrder.indexOf(a);
    const bIndex = labelOrder.indexOf(b);

    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
    if (aIndex !== -1) return -1;
    if (bIndex !== -1) return 1;

    // For date labels, parse and compare
    return new Date(groups[b][0].started_at || groups[b][0].created_at) -
      new Date(groups[a][0].started_at || groups[a][0].created_at);
  });

  return { groups, labels: sortedLabels };
}

/**
 * Toggle a date group collapsed/expanded (not used - dates shown simply)
 */
function toggleDateGroup(label) {
  // Disabled - dates are shown simply without collapse
}

/**
 * Render stories to the feed with date grouping
 */
function renderStories(stories, containerId = 'feed', options = {}) {
  const feed = document.getElementById(containerId);
  const searchQuery = store.get('searchQuery');

  if (!stories || !stories.length) {
    if (searchQuery) {
      feed.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-title">No matches found</div>
          <div style="font-size: 14px;">Try adjusting your search query or filters</div>
          <button class="btn btn-secondary" onclick="document.getElementById('search-input').value=''; store.update('searchQuery', ''); filterAndRenderStories();" style="margin-top: 16px;">Clear Search</button>
        </div>`;
    } else {
      feed.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-title">Your timeline is empty</div>
          <div style="font-size: 14px;">Run your first generation to see your development story</div>
          <button class="btn btn-primary" onclick="triggerGenerationClick()" style="margin-top: 16px;">Generate Now</button>
        </div>`;
    }
    return;
  }

  // If searching, don't group - show flat list with highlights
  if (searchQuery) {
    feed.innerHTML = stories.map(s => renderStoryCard(s, searchQuery, options)).join('');
    return;
  }

  // Group stories by date
  const { groups, labels } = groupStoriesByDate(stories);

  let html = '';
  labels.forEach(label => {
    const groupStories = groups[label];

    html += `
      <div class="date-header">
        <span class="date-header-label">${label}</span>
      </div>
      ${groupStories.map(s => renderStoryCard(s, searchQuery, options)).join('')}
    `;
  });

  feed.innerHTML = html;
}

/**
 * Render a single story card
 */
function renderStoryCard(s, searchQuery, options = {}) {
  const timeStr = timeSince(new Date(s.started_at || s.created_at));
  const category = s.category || 'chore';
  const repoName = s.repo_name || 'cli';
  let username = s.author_name || s.username || 'unknown';
  const isVerified = s.verified || false;

  const displayTitle = highlightText(cleanTitle(s.title), searchQuery);
  const displayProblem = s.problem ? highlightText(s.problem, searchQuery) : '';
  const displayApproach = s.approach ? highlightText(s.approach, searchQuery) : '';

  let avatarColor = stringToColor(username);
  let avatarLetter = username.substring(0, 1).toUpperCase();
  let displayUsername = highlightText(username, searchQuery);
  let handleText = `@${repoName}`;
  const verifiedBadge = isVerified ? '<span class="verified-badge" title="GPG signed commits">✓</span>' : '';

  let contributionNote = '';

  // Override for profile view (Repository as Author)
  if (options.useRepoAsAuthor) {
    username = repoName; // The author is the repo
    displayUsername = repoName;
    avatarColor = stringToColor(repoName);
    avatarLetter = repoName.substring(0, 1).toUpperCase();
    handleText = `@${repoName}`;

    // Original author credit
    const originalAuthor = s.author_name || s.username || 'unknown';
    contributionNote = `<div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;"> <span style="opacity:0.7">Contributed by</span> <span style="font-weight:500">${escapeHtml(originalAuthor)}</span></div>`;
  }

  // Tags as hashtags (clickable to filter)
  const tags = [];
  if (s.technologies && s.technologies.length) {
    s.technologies.slice(0, 3).forEach(t => tags.push(t.toLowerCase().replace(/\s+/g, '')));
  }
  const tagsHtml = tags.length ? tags.map(t => `<span class="hashtag" onclick="filterByTag(event, '${t}')">#${highlightText(t, searchQuery)}</span>`).join(' ') : '';

  // Combine title and problem/approach as the post content
  const bodyText = displayProblem || displayApproach;

  // Media content (diagrams, show output)
  let mediaHtml = '';
  if (s.diagram) {
    mediaHtml += `<div class="post-media"><pre class="post-diagram">${escapeHtml(s.diagram)}</pre></div>`;
  }
  if (s.show) {
    mediaHtml += `<div class="post-media"><pre class="post-output">${escapeHtml(s.show)}</pre></div>`;
  }

  return `
    <article class="post-card" id="post-${s.id}" onclick="openStory(event, '${s.id}')">
      <div class="post-avatar" style="background:${avatarColor}; cursor: pointer;" onclick="openProfile(event, '${repoName}')">${avatarLetter}</div>
      <div class="post-body">
        ${options.useRepoAsAuthor ? contributionNote : ''}
        <div class="post-header">
          <span class="post-author" onclick="openProfile(event, '${repoName}')">${displayUsername}${!options.useRepoAsAuthor ? verifiedBadge : ''}</span>
          <span class="post-handle" onclick="openProfile(event, '${repoName}')">${handleText}</span>
          <span class="post-meta-sep">·</span>
          <span class="post-time">${timeStr}</span>
        </div>
        <div class="post-text"><strong>${displayTitle}</strong>${bodyText ? `\n${bodyText}` : ''}</div>
        ${mediaHtml}
        ${tagsHtml ? `<div class="post-tags">${tagsHtml}</div>` : ''}
        <div class="post-actions">
          <div class="post-action" title="${category}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
            </svg>
            <span>${s.total_commits || ''}</span>
          </div>
          <div class="post-action" title="Like">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
          </div>
        </div>
      </div>
    </article>
  `;
}

/**
 * Open story detail view
 */
/**
 * Open story detail view
 */
function openStory(event, storyId, pushState = true) {
  const stories = store.get('stories');
  const story = stories.find(s => s.id === storyId);
  if (!story) return;

  if (pushState) {
    window.lastScrollY = window.scrollY;

    // Determine current view for back button logic if any
    if (document.getElementById('view-profile').classList.contains('open')) {
      store.update('previousView', 'view-profile');
    } else {
      store.update('previousView', 'view-main');
    }

    store.pushHistory({ view: 'detail', storyId: storyId }, `Repr - ${cleanTitle(story.title)}`, `?story=${storyId}`);
  }

  const detailView = document.getElementById('view-detail');
  detailView.classList.add('open');
  window.scrollTo(0, 0);

  const contentEl = document.getElementById('detail-content');
  const timeStr = timeSince(new Date(story.started_at || story.created_at));
  const category = story.category || 'update';
  const repoName = story.repo_name || 'cli';
  const username = story.author_name || story.username || 'unknown';
  const isVerified = story.verified || false;
  const displayTitle = cleanTitle(story.title);

  const verifiedBadge = isVerified ? '<span class="verified-badge" title="GPG signed commits">✓</span>' : '';
  const signatureInfo = story.signature_status ? `
    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
      ${isVerified ? '🔒 All commits GPG signed' : story.signature_status === 'partially_signed' ? '⚠️ Some commits unsigned' : '⚠️ Unsigned commits'}
      ${story.signed_count !== undefined ? ` (${story.signed_count}/${story.total_commits} signed)` : ''}
    </div>
  ` : '';

  const techHtml = (story.technologies && story.technologies.length) ?
    `<div class="skills-inline">${story.technologies.map(t => `<span class="skill-tag">${escapeHtml(t)}</span>`).join('')}</div>` : '';

  const showHtml = story.show ? `<div class="snippet-block" style="margin-top:16px"><div class="snippet-header">Output</div><div class="snippet-code"><pre>${escapeHtml(story.show)}</pre></div></div>` : '';

  const diagramHtml = story.diagram ? `<div class="diagram-block"><pre>${escapeHtml(story.diagram)}</pre></div>` : '';

  const filesHtml = (story.files && story.files.length) ?
    `<div class="section-subtitle">Files Touched</div>
     <div class="files-row">
       ${story.files.map(f => `<span class="file-tag">${escapeHtml(f.split('/').pop())}</span>`).join('')}
     </div>` : '';

  const snippetsHtml = (story.key_snippets && story.key_snippets.length) ?
    `<div class="section-subtitle">Key Snippets</div>
     ${story.key_snippets.map(s => `
       <div class="snippet-block">
         <div class="snippet-header">${escapeHtml(s.file_path)}</div>
         <div class="snippet-code"><pre>${escapeHtml(s.content)}</pre></div>
       </div>
     `).join('')}` : '';

  const fileChangesHtml = (story.file_changes && story.file_changes.length) ?
    `<div class="section-subtitle">File Changes</div>
     <ul style="padding-left:16px; color:var(--text-secondary); font-size:15px; margin-bottom: 24px; list-style: none;">
       ${story.file_changes.map(ch => {
      const path = ch.file_path || ch.path || 'unknown';
      const changeType = ch.change_type || 'modified';
      const insertions = ch.insertions || 0;
      const deletions = ch.deletions || 0;
      const stats = [];
      if (insertions > 0) stats.push(`<span style="color: var(--green);">+${insertions}</span>`);
      if (deletions > 0) stats.push(`<span style="color: var(--red);">-${deletions}</span>`);
      const statsStr = stats.length > 0 ? stats.join('/') : '0 changes';
      return `<li style="margin-bottom: 4px; font-family: var(--font-mono); font-size: 13px;">
           <span style="color: var(--text-muted);">[${changeType}]</span> ${escapeHtml(path.split('/').pop())}
           <span style="margin-left: 8px; font-size: 12px;">${statsStr}</span>
         </li>`;
    }).join('')}
     </ul>` : '';

  const avatarColor = stringToColor(username);
  const avatarLetter = username.substring(0, 2).toUpperCase();

  contentEl.innerHTML = `
    <div class="post" style="border-bottom: 0; cursor: default; padding: 16px;">
        <div class="post-content">
            <div class="post-header">
              <div class="user-info" onclick="openProfile(event, '${repoName}')">
                <div class="tiny-avatar" style="background:${avatarColor}">${avatarLetter}</div>
                <div>
                  <span class="name">/u/${escapeHtml(username)}${verifiedBadge}</span>
                  <span style="color: var(--text-muted); font-size: 12px; margin-left: 4px;">/r/${repoName}</span>
                  ${signatureInfo}
                </div>
              </div>
              <span class="category ${category}">${category}</span>
              <span class="time">${timeStr}</span>
              ${techHtml}
            </div>
            <div class="post-title" style="font-size: 24px;">${escapeHtml(displayTitle)}</div>
            ${story.problem ? `<div class="post-problem" style="font-size: 16px; margin-bottom:12px;">${escapeHtml(story.problem)}</div>` : ''}
            ${story.approach ? `<div class="post-approach" style="font-size: 16px;">${escapeHtml(story.approach)}</div>` : ''}

            ${showHtml}
            ${diagramHtml}

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 32px 0;">

            ${story.lessons && story.lessons.length ? `
              <div class="insight-box">
                <div class="insight-label">Transferable Insight</div>
                ${story.lessons.map(l => `<div class="insight-text">${escapeHtml(l)}</div>`).join('')}
              </div>
            ` : ''}

            ${story.implementation_details && story.implementation_details.length ? `
               <div class="section-subtitle">Implementation Details</div>
               <ul style="padding-left:16px; color:var(--text-secondary); font-size:15px; line-height:1.6; margin-bottom: 24px;">
                 ${story.implementation_details.map(d => `<li>${escapeHtml(d)}</li>`).join('')}
               </ul>
            ` : ''}

            ${filesHtml}
            ${snippetsHtml}
            ${fileChangesHtml}
        </div>
      </div>
  `;
}

/**
 * Open profile view for a repository
 */
/**
 * Open profile view for a repository
 */
function openProfile(event, repoName, pushState = true) {
  if (event) event.stopPropagation();

  if (pushState) {
    window.lastScrollY = window.scrollY;
    store.update('previousView', 'view-profile');
    store.pushHistory({ view: 'profile', repoName: repoName }, `Repr - @${repoName}`, `?profile=${repoName}`);
  }

  document.getElementById('view-main').style.display = 'none';
  document.getElementById('view-detail').classList.remove('open');

  const profileView = document.getElementById('view-profile');
  profileView.classList.add('open');
  window.scrollTo(0, 0);

  const avatarColor = stringToColor(repoName);
  const avatarLetter = repoName.substring(0, 1).toUpperCase();

  // Avatar
  const avatarEl = document.getElementById('profile-view-avatar');
  avatarEl.style.background = avatarColor;
  avatarEl.textContent = avatarLetter;

  // Header
  document.getElementById('profile-view-name').textContent = repoName;
  document.getElementById('profile-nav-name').textContent = repoName;
  document.getElementById('profile-view-handle').textContent = '@' + repoName;

  // Cover gradients based on repo name hash
  const hue1 = Math.abs(stringToColor(repoName + '1').hashCode() || 0) % 360;
  const hue2 = Math.abs(stringToColor(repoName + '2').hashCode() || 0) % 360;
  document.getElementById('profile-cover').style.background = `linear-gradient(135deg, hsl(${hue1}, 70%, 80%) 0%, hsl(${hue2}, 70%, 85%) 100%)`;

  const stories = store.get('stories');
  const profileStories = stories.filter(s => s.repo_name === repoName);

  // Stats
  const totalCommits = profileStories.reduce((acc, s) => acc + (s.total_commits || 0), 0);
  const contributors = new Set(profileStories.map(s => s.author_name)).size;

  document.getElementById('profile-stories-count').textContent = profileStories.length;
  document.getElementById('profile-commits-count').textContent = totalCommits;
  document.getElementById('profile-contributors-count').textContent = contributors;
  document.getElementById('profile-stats-count').textContent = `+${contributors} contributors`; // Using contributors count for top pill for now

  // Bio
  const latestStory = profileStories[0];
  const lastActive = latestStory ? timeSince(new Date(latestStory.started_at || latestStory.created_at)) : 'a while ago';
  document.getElementById('profile-view-bio').textContent = `Repository tracked by Repr. Active ${lastActive}. Contains ${profileStories.length} stories.`;

  renderStories(profileStories, 'profile-feed', { useRepoAsAuthor: true });
}

// Helper to get simple hash code from color string (or just random if needed, but keeping it deterministic is better)
String.prototype.hashCode = function () {
  let hash = 0, i, chr;
  if (this.length === 0) return hash;
  for (i = 0; i < this.length; i++) {
    chr = this.charCodeAt(i);
    hash = ((hash << 5) - hash) + chr;
    hash |= 0;
  }
  return hash;
};

/**
 * Go back to previous view
 */
/**
 * Go back to previous view
 */
function goBack() {
  if (history.length > 1) {
    history.back();
  } else {
    // Fallback if no history
    const detailView = document.getElementById('view-detail');
    const profileView = document.getElementById('view-profile');

    if (detailView.classList.contains('open')) {
      detailView.classList.remove('open');
    } else if (profileView.classList.contains('open')) {
      profileView.classList.remove('open');
      document.getElementById('view-main').style.display = 'flex';
    }

    if (window.lastScrollY) window.scrollTo(0, window.lastScrollY);
  }
}

/**
 * Refresh stories from API
 */
async function refreshStories() {
  showToast('Refreshing...', 'success');
  await initStories();
}

/**
 * Trigger manual story generation
 */
async function triggerGenerationClick() {
  if (!confirm('Start generating stories now? This will run in the background.')) return;

  try {
    const result = await triggerGeneration();

    if (result.success) {
      showToast('Generation started', 'success');
    } else {
      showToast('Failed to start generation', 'error');
    }
  } catch (error) {
    showToast('Error triggering generation', 'error');
  }
}

/**
 * Render skeleton loaders
 */
function renderSkeletons(containerId = 'feed', count = 3) {
  const feed = document.getElementById(containerId);
  if (!feed) return;

  let html = '';
  for (let i = 0; i < count; i++) {
    html += `
      <div class="skeleton-card">
        <div class="skeleton-avatar skeleton"></div>
        <div class="skeleton-body">
          <div class="skeleton-header skeleton"></div>
          <div class="skeleton-title skeleton"></div>
          <div class="skeleton-text skeleton"></div>
          <div class="skeleton-text skeleton" style="width: 60%"></div>
        </div>
      </div>
    `;
  }
  feed.innerHTML = html;
}

/**
 * Filter stories by hashtag
 */
function filterByTag(event, tag) {
  if (event) event.stopPropagation();

  const searchInput = document.getElementById('search-input');
  searchInput.value = tag;
  store.update('searchQuery', tag.toLowerCase());
  filterAndRenderStories();

  // Make sure we're on the stories view
  switchMainView('stories', false);
}

// Expose functions to global scope for inline onclick handlers
window.openStory = openStory;
window.openProfile = openProfile;
window.filterByTag = filterByTag;
window.triggerGenerationClick = triggerGenerationClick;
window.goBack = goBack;
window.refreshStories = refreshStories;


/**
 * Settings Module
 * Handles settings and configuration management
 */

/**
 * Switch between main views (stories, settings, repos, etc.)
 */
/**
 * Switch between main views (stories, settings, repos, etc.)
 */
function switchMainView(view, pushState = true) {
  store.update('currentMainView', view);

  if (pushState) {
    store.pushHistory({ view: 'main', mainView: view }, `Repr - ${view.charAt(0).toUpperCase() + view.slice(1)}`, `?view=${view}`);
  }

  document.querySelectorAll('.sidebar-item').forEach(item => {
    item.classList.toggle('active', item.dataset.view === view);
  });

  document.querySelectorAll('.mobile-nav-item').forEach(item => {
    const itemText = item.querySelector('span:last-child').textContent.toLowerCase();
    item.classList.toggle('active', view.startsWith(itemText));
  });

  // Close sidebar on mobile if open
  const sidebar = document.querySelector('.sidebar');
  if (sidebar.classList.contains('open')) {
    toggleSidebar();
  }

  // Hide all views
  ['stories', 'settings', 'llm', 'privacy', 'repos', 'cron'].forEach(v => {
    const el = document.getElementById('view-' + v);
    if (el) el.style.display = 'none';
  });

  // Show selected view
  const activeView = document.getElementById('view-' + view);
  if (activeView) activeView.style.display = 'block';

  // Load data if needed
  if (['settings', 'llm', 'privacy', 'cron'].includes(view) && !store.get('config')) {
    loadConfig();
  }

  if (view === 'repos') {
    loadRepos();
  }

  if (view === 'cron') {
    loadCronStatus();
  }
}

/**
 * Switch between settings tabs (form, json)
 */
function switchSettingsTab(tab) {
  store.update('currentSettingsTab', tab);

  document.querySelectorAll('.settings-nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.tab === tab);
  });

  document.getElementById('settings-form').style.display = tab === 'form' ? 'block' : 'none';
  document.getElementById('settings-json').style.display = tab === 'json' ? 'block' : 'none';

  if (tab === 'json') {
    const config = store.get('config');
    if (config) {
      document.getElementById('json-editor').value = JSON.stringify(config, null, 2);
    }
  }
}

/**
 * Load configuration from API
 */
async function loadConfig() {
  try {
    const config = await getConfig();
    store.batchUpdate({
      config: config,
      configDirty: false
    });
    populateForm(config);
    document.getElementById('json-editor').value = JSON.stringify(config, null, 2);
    updateSaveButtons();
  } catch (error) {
    showToast('Failed to load config', 'error');
  }
}

/**
 * Populate form fields with config data
 */
function populateForm(config) {
  // LLM Settings
  document.getElementById('llm-default').value = config.llm?.default || 'local';
  document.getElementById('llm-local-provider').value = config.llm?.local_provider || '';
  document.getElementById('llm-local-model').value = config.llm?.local_model || '';
  document.getElementById('llm-local-url').value = config.llm?.local_api_url || '';

  // Generation Settings
  document.getElementById('gen-batch-size').value = config.generation?.batch_size || 5;
  document.getElementById('gen-max-commits').value = config.generation?.max_commits_per_batch || 50;
  document.getElementById('gen-template').value = config.generation?.default_template || 'resume';
  document.getElementById('gen-auto-hook').checked = config.generation?.auto_generate_on_hook || false;

  // Privacy Settings
  document.getElementById('privacy-local-only').checked = config.privacy?.lock_local_only || false;
  document.getElementById('privacy-redact-paths').checked = config.llm?.cloud_redact_paths !== false;
  document.getElementById('privacy-redact-emails').checked = config.llm?.cloud_redact_emails || false;
  document.getElementById('privacy-send-diffs').checked = config.llm?.cloud_send_diffs || false;
  document.getElementById('privacy-visibility').value = config.privacy?.profile_visibility || 'public';

  // Cron Settings
  document.getElementById('cron-interval').value = config.cron?.interval_hours || 4;
  document.getElementById('cron-min-commits').value = config.cron?.min_commits || 3;
  document.getElementById('cron-installed').checked = config.cron?.installed || false;
  document.getElementById('cron-paused').checked = config.cron?.paused || false;

  // Paths
  renderTags('default-paths-container', config.settings?.default_paths || ['~/code'], 'path');
  renderTags('skip-patterns-container', config.settings?.skip_patterns || [], 'pattern');
}

/**
 * Collect form data into config object
 */
function collectFormData() {
  const config = JSON.parse(JSON.stringify(store.get('config'))); // Deep clone

  // LLM Settings
  config.llm = config.llm || {};
  config.llm.default = document.getElementById('llm-default').value;
  config.llm.local_provider = document.getElementById('llm-local-provider').value || null;
  config.llm.local_model = document.getElementById('llm-local-model').value || null;
  config.llm.local_api_url = document.getElementById('llm-local-url').value || null;

  // Generation Settings
  config.generation = config.generation || {};
  config.generation.batch_size = parseInt(document.getElementById('gen-batch-size').value) || 5;
  config.generation.max_commits_per_batch = parseInt(document.getElementById('gen-max-commits').value) || 50;
  config.generation.default_template = document.getElementById('gen-template').value;
  config.generation.auto_generate_on_hook = document.getElementById('gen-auto-hook').checked;

  // Privacy Settings
  config.privacy = config.privacy || {};
  config.privacy.lock_local_only = document.getElementById('privacy-local-only').checked;
  config.privacy.profile_visibility = document.getElementById('privacy-visibility').value;
  config.llm.cloud_redact_paths = document.getElementById('privacy-redact-paths').checked;
  config.llm.cloud_redact_emails = document.getElementById('privacy-redact-emails').checked;
  config.llm.cloud_send_diffs = document.getElementById('privacy-send-diffs').checked;

  // Cron Settings
  config.cron = config.cron || {};
  config.cron.interval_hours = parseInt(document.getElementById('cron-interval').value) || 4;
  config.cron.min_commits = parseInt(document.getElementById('cron-min-commits').value) || 3;
  config.cron.installed = document.getElementById('cron-installed').checked;
  config.cron.paused = document.getElementById('cron-paused').checked;

  // Paths
  config.settings = config.settings || {};
  config.settings.default_paths = collectTags('default-paths-container');
  config.settings.skip_patterns = collectTags('skip-patterns-container');

  return config;
}

/**
 * Save configuration
 */
async function saveConfig() {
  try {
    const config = collectFormData();
    await updateConfig(config);

    store.batchUpdate({
      config: config,
      configDirty: false
    });
    updateSaveButtons();
    showToast('Configuration saved', 'success');
  } catch (error) {
    showToast('Failed to save config', 'error');
  }
}

/**
 * Save JSON configuration
 */
async function saveJsonConfig() {
  try {
    const jsonText = document.getElementById('json-editor').value;
    const config = JSON.parse(jsonText);
    await updateConfig(config);

    store.batchUpdate({
      config: config,
      configDirty: false
    });
    populateForm(config);
    updateSaveButtons();
    showToast('Configuration saved', 'success');
  } catch (error) {
    if (error instanceof SyntaxError) {
      showToast('Invalid JSON syntax', 'error');
    } else {
      showToast('Failed to save config', 'error');
    }
  }
}

/**
 * Format JSON in editor
 */
function formatJson() {
  try {
    const editor = document.getElementById('json-editor');
    const parsed = JSON.parse(editor.value);
    editor.value = JSON.stringify(parsed, null, 2);
  } catch (e) {
    showToast('Invalid JSON - cannot format', 'error');
  }
}

/**
 * Mark config as dirty (needs saving)
 */
function markConfigDirty() {
  store.update('configDirty', true);
  updateSaveButtons();
}

/**
 * Update save button states
 */
function updateSaveButtons() {
  const configDirty = store.get('configDirty');
  const btns = ['save-btn', 'save-json-btn', 'save-llm-btn', 'save-privacy-btn', 'save-cron-btn'];

  btns.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.disabled = !configDirty;
  });
}

/**
 * Load cron status
 */
async function loadCronStatus() {
  try {
    const status = await getCronStatus();
    store.update('cronStatus', status);
    renderCronStatus(status);
  } catch (error) {
    document.getElementById('cron-status').innerHTML = '<div class="loading-text">Failed to load cron status</div>';
  }
}

/**
 * Render cron status
 */
function renderCronStatus(status) {
  const container = document.getElementById('cron-status');

  let stateText = 'Not installed';
  let stateClass = 'inactive';

  if (status.installed) {
    if (status.paused) {
      stateText = 'Paused';
      stateClass = 'paused';
    } else {
      stateText = 'Active';
      stateClass = 'active';
    }
  }

  container.innerHTML = `
    <div class="cron-status-row">
      <span class="cron-status-label">Status</span>
      <span class="cron-status-value ${stateClass}">${stateText}</span>
    </div>
    <div class="cron-status-row">
      <span class="cron-status-label">Interval</span>
      <span class="cron-status-value">${status.interval_hours ? status.interval_hours + ' hours' : 'Not set'}</span>
    </div>
    <div class="cron-status-row">
      <span class="cron-status-label">Min Commits</span>
      <span class="cron-status-value">${status.min_commits || 'Not set'}</span>
    </div>
  `;
}

/**
 * Tags Input Functions
 */
function renderTags(containerId, tags, type) {
  const container = document.getElementById(containerId);
  const input = container.querySelector('input');

  // Remove existing tags
  container.querySelectorAll('.tag-item').forEach(el => el.remove());

  // Add tags before input
  tags.forEach(tag => {
    const tagEl = document.createElement('span');
    tagEl.className = 'tag-item';
    tagEl.innerHTML = `${escapeHtml(tag)}<span class="tag-remove" onclick="removeTag(this, '${type}')">&times;</span>`;
    container.insertBefore(tagEl, input);
  });
}

function collectTags(containerId) {
  const container = document.getElementById(containerId);
  return Array.from(container.querySelectorAll('.tag-item'))
    .map(el => el.textContent.slice(0, -1)); // Remove the × character
}

function removeTag(el, type) {
  el.parentElement.remove();
  markConfigDirty();
}

function handlePathInput(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    const input = event.target;
    const value = input.value.trim();
    if (value) {
      const container = input.parentElement;
      const tagEl = document.createElement('span');
      tagEl.className = 'tag-item';
      tagEl.innerHTML = `${escapeHtml(value)}<span class="tag-remove" onclick="removeTag(this, 'path')">&times;</span>`;
      container.insertBefore(tagEl, input);
      input.value = '';
      markConfigDirty();
    }
  }
}

function handlePatternInput(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    const input = event.target;
    const value = input.value.trim();
    if (value) {
      const container = input.parentElement;
      const tagEl = document.createElement('span');
      tagEl.className = 'tag-item';
      tagEl.innerHTML = `${escapeHtml(value)}<span class="tag-remove" onclick="removeTag(this, 'pattern')">&times;</span>`;
      container.insertBefore(tagEl, input);
      input.value = '';
      markConfigDirty();
    }
  }
}

// Expose functions to global scope for inline onclick handlers
window.switchMainView = switchMainView;
window.loadConfig = loadConfig;
window.saveConfig = saveConfig;
window.saveJsonConfig = saveJsonConfig;
window.formatJson = formatJson;
window.switchSettingsTab = switchSettingsTab;


/**
 * Repos Module
 * Handles repository management
 */

/**
 * Load repositories from API
 */
async function loadRepos() {
  try {
    const data = await getRepos();
    store.update('repos', data.repos || []);
    renderRepos();
  } catch (error) {
    document.getElementById('repos-list').innerHTML = '<div class="loading-text">Failed to load repositories</div>';
  }
}

/**
 * Render repositories list
 */
function renderRepos() {
  const repos = store.get('repos');
  const container = document.getElementById('repos-list');

  if (!repos.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-title">No repositories tracked</div>
        <div>Add a repository path above to start tracking</div>
      </div>`;
    return;
  }

  container.innerHTML = repos.map(repo => {
    const projectName = repo.project?.name || '';
    const displayName = projectName || repo.origin_name || repo.path.split('/').pop();
    const isPaused = repo.paused;
    const isMissing = !repo.exists;
    const hasHook = repo.hook_installed;

    let statusClass = 'active';
    if (isMissing) statusClass = 'missing';
    else if (isPaused) statusClass = 'paused';

    const originUrl = repo.origin ? convertGitUrlToWeb(repo.origin) : null;
    const escapedPath = escapeHtml(repo.path).replace(/'/g, "\\'");

    return `
      <div class="repo-item ${isPaused ? 'paused' : ''} ${isMissing ? 'missing' : ''}">
        <div class="repo-info">
          <div class="repo-name-row">
            <span class="repo-name" id="repo-name-${escapedPath}" onclick="editRepoName('${escapedPath}')">${escapeHtml(displayName)}</span>
            <button class="repo-edit-btn" onclick="editRepoName('${escapedPath}')" title="Edit name">✎</button>
            ${originUrl ? `<a href="${escapeHtml(originUrl)}" target="_blank" rel="noopener noreferrer" class="repo-link" title="Open repository"><span class="repo-link-icon">&#8599;</span></a>` : ''}
          </div>
          <div class="repo-path">${escapeHtml(repo.path)}</div>
          <div class="repo-status">
            <span class="repo-badge ${statusClass}">${isMissing ? 'Missing' : isPaused ? 'Paused' : 'Active'}</span>
            ${hasHook ? '<span class="repo-badge hook">Hook</span>' : ''}
            ${repo.last_sync ? `<span style="font-size: 11px; color: var(--text-muted);">Last sync: ${new Date(repo.last_sync).toLocaleDateString()}</span>` : ''}
          </div>
        </div>
        <div class="repo-actions">
          ${isPaused
            ? `<button class="repo-action-btn" onclick="resumeRepoClick('${escapedPath}')">Resume</button>`
            : `<button class="repo-action-btn" onclick="pauseRepoClick('${escapedPath}')">Pause</button>`
          }
          <button class="repo-action-btn danger" onclick="removeRepoClick('${escapedPath}')">Remove</button>
        </div>
      </div>
    `;
  }).join('');
}

/**
 * Add repository
 */
async function addRepoClick() {
  const input = document.getElementById('add-repo-path');
  const path = input.value.trim();

  if (!path) {
    showToast('Please enter a repository path', 'error');
    return;
  }

  try {
    const result = await addRepo(path);

    if (result.success) {
      input.value = '';
      showToast('Repository added', 'success');
      loadRepos();
    } else {
      showToast(result.error || 'Failed to add repository', 'error');
    }
  } catch (error) {
    showToast('Failed to add repository', 'error');
  }
}

/**
 * Remove repository
 */
async function removeRepoClick(path) {
  if (!confirm('Remove this repository from tracking?')) return;

  try {
    const result = await removeRepo(path);

    if (result.success) {
      showToast('Repository removed', 'success');
      loadRepos();
    } else {
      showToast('Failed to remove repository', 'error');
    }
  } catch (error) {
    showToast('Failed to remove repository', 'error');
  }
}

/**
 * Pause repository
 */
async function pauseRepoClick(path) {
  try {
    const result = await pauseRepo(path);

    if (result.success) {
      showToast('Repository paused', 'success');
      loadRepos();
    } else {
      showToast('Failed to pause repository', 'error');
    }
  } catch (error) {
    showToast('Failed to pause repository', 'error');
  }
}

/**
 * Resume repository
 */
async function resumeRepoClick(path) {
  try {
    const result = await resumeRepo(path);

    if (result.success) {
      showToast('Repository resumed', 'success');
      loadRepos();
    } else {
      showToast('Failed to resume repository', 'error');
    }
  } catch (error) {
    showToast('Failed to resume repository', 'error');
  }
}

/**
 * Convert git URL to web URL
 * Converts git@host:user/repo.git to https://host/user/repo
 */
function convertGitUrlToWeb(url) {
  if (!url) return null;

  // Already an HTTP(S) URL
  if (url.startsWith('http://') || url.startsWith('https://')) {
    return url;
  }

  // SSH format: git@github.com:user/repo.git
  const sshMatch = url.match(/^git@([^:]+):(.+?)(\.git)?$/);
  if (sshMatch) {
    const host = sshMatch[1];
    const path = sshMatch[2];
    return `https://${host}/${path}`;
  }

  // git:// format: git://github.com/user/repo.git
  const gitMatch = url.match(/^git:\/\/(.+?)(\.git)?$/);
  if (gitMatch) {
    return `https://${gitMatch[1]}`;
  }

  // Return original if can't convert
  return url;
}

/**
 * Edit repository name
 */
function editRepoName(path) {
  const repos = store.get('repos');
  const repo = repos.find(r => r.path === path);
  if (!repo) return;

  const currentName = repo.project?.name || repo.origin_name || repo.path.split('/').pop();
  
  const modal = document.getElementById('edit-repo-modal');
  const nameInput = document.getElementById('edit-repo-name-input');
  const pathInput = document.getElementById('edit-repo-path-input');
  
  nameInput.value = currentName;
  pathInput.value = path;
  
  openModal('edit-repo-modal');
  
  // Focus and select the text
  setTimeout(() => {
    nameInput.focus();
    nameInput.select();
  }, 100);
}

/**
 * Save repository edit from modal
 */
async function saveRepoEdit() {
  const nameInput = document.getElementById('edit-repo-name-input');
  const pathInput = document.getElementById('edit-repo-path-input');
  
  const newName = nameInput.value.trim();
  const path = pathInput.value;

  if (newName === '') {
    showToast('Name cannot be empty', 'error');
    return;
  }

  const saveBtn = document.getElementById('save-repo-btn');
  const originalText = saveBtn.textContent;
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  try {
    const result = await renameRepo(path, newName);

    if (result.success) {
      showToast('Project renamed', 'success');
      closeModal('edit-repo-modal');
      loadRepos();
    } else {
      showToast(result.error || 'Failed to rename project', 'error');
    }
  } catch (error) {
    showToast('Failed to rename project', 'error');
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = originalText;
  }
}

/**
 * Rename repository project
 */
async function renameRepoClick(path, name) {
  try {
    const result = await renameRepo(path, name);

    if (result.success) {
      showToast('Project renamed', 'success');
      loadRepos();
    } else {
      showToast(result.error || 'Failed to rename project', 'error');
    }
  } catch (error) {
    showToast('Failed to rename project', 'error');
  }
}

// Expose functions to global scope for inline onclick handlers
window.addRepoClick = addRepoClick;
window.editRepoName = editRepoName;
window.saveRepoEdit = saveRepoEdit;

  </script>
  
  
  
  
  
  
  

  <!-- Initialize -->
  <script>
    // Detect Windows/Linux for keyboard shortcut hints
    if (!/(Mac|iPhone|iPad|iPod)/i.test(navigator.platform)) {
      document.body.classList.add('is-windows');
    }

    // Initialize theme first (before any rendering)
    initTheme();

    // Initialize keyboard navigation
    initKeyboard();

    // Setup search input listener
    document.getElementById('search-input').addEventListener('input', (e) => {
      store.update('searchQuery', e.target.value.trim().toLowerCase());
      filterAndRenderStories();
    });

    // Initialize stories
    initStories();
  </script>
</body>

</html>